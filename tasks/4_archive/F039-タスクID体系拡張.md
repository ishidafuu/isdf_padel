---
id: "F039"
title: "タスクID体系拡張"
type: "framework"
status: "done"
priority: "medium"
spec_ids: []
blocked_by: []
blocks: []
branch_name: null
worktree_path: null
plan_file: "/Users/ishidafuu/.claude/plans/streamed-mapping-lantern.md"
tags: ["task-management", "id-system"]
created_at: "2026-01-07T12:00:00+09:00"
updated_at: "2026-01-07T13:00:00+09:00"
completed_at: "2026-01-07T13:00:00+09:00"
---

# Task F039: タスクID体系拡張

## 説明

バグ修正・リファクタリング用のタスクIDプレフィックスを追加し、機能IDの枯渇を防ぐ。

## 背景

### 現状
- ゲーム開発タスクID（30XXX）は仕様書IDと同じ番号体系
- 機能実装もバグ修正も同じ連番を消費
- 長期運用でID枯渇リスクあり（ingame層で約400個の余裕）

### 改修理由
- 機能IDとメンテナンスIDを分離して枯渇を防ぐ
- バグ修正・リファクタの統計が容易に
- 元機能との関連が一目瞭然

## 実装内容

- [x] `.claude/commands/id-next.md` - B/Rプレフィックス採番ロジック追加
- [x] `.claude/skills/task-file-format.md` - タスクタイプ・命名規則・Frontmatter追加
- [x] `.claude/agents/task-registration-agent.md` - 判定・登録フロー追加
- [x] `docs/reference/framework-spec.md` - タスクID体系セクション追加
- [x] `CLAUDE.md` の表を更新（タスク種別表）

## 新タスクID体系

| タイプ | 形式 | 例 | 説明 |
|--------|------|-----|------|
| 機能実装 | `30XXX` | 30101 | 新機能の実装（現行） |
| バグ修正 | `B30XXX-NNN` | B30101-001 | 30101機能のバグ修正1件目 |
| リファクタ | `R30XXX-NNN` | R30101-001 | 30101機能の改善1件目 |

## メモ

- worktree対応: B/Rタスクも game-dev 同様 worktree 有効
- 後方互換: 既存タスクに影響なし
- 採番コマンド: `/id-next B30101` のような引数形式

## 依存関係

- **ブロック**: なし
- **ブロックされる**: なし
- **関連ドキュメント**:
  - docs/reference/framework-spec.md
  - .claude/skills/task-file-format.md

---

## Detailed Implementation Plan

以下は、プランファイル `~/.claude/plans/streamed-mapping-lantern.md` の全内容です。

# タスクID体系拡張プラン

## 概要
バグ修正・リファクタリング用のタスクIDプレフィックスを追加し、機能IDの枯渇を防ぐ。

## 背景

### 現状
- ゲーム開発タスクID（30XXX）は仕様書IDと同じ番号体系
- 機能実装もバグ修正も同じ連番を消費
- 長期運用でID枯渇リスクあり（ingame層で約400個の余裕）

### 改修理由
- 機能IDとメンテナンスIDを分離して枯渇を防ぐ
- バグ修正・リファクタの統計が容易に
- 元機能との関連が一目瞭然

## 新タスクID体系

| タイプ | 形式 | 例 | 説明 |
|--------|------|-----|------|
| 機能実装 | `30XXX` | 30101 | 新機能の実装（現行） |
| バグ修正 | `B30XXX-NNN` | B30101-001 | 30101機能のバグ修正1件目 |
| リファクタ | `R30XXX-NNN` | R30101-001 | 30101機能の改善1件目 |

## 変更対象ファイル

### 1. `.claude/commands/id-next.md`
**変更内容**: バグ修正/リファクタID採番のサポート追加

```markdown
### バグ修正/リファクタID採番の場合

引数が `B30XXX` または `R30XXX` のような形式の場合:

/id-next B30101    # → B30101-001（既存がない場合）
/id-next B30101    # → B30101-002（既存が001の場合）
/id-next R30201    # → R30201-001

1. 元のタスクID（30101等）を特定
2. 既存の B30101-* または R30201-* を検索
3. 最大の連番 + 1 を計算
4. 以下の形式で出力:

次のID: B30101-002

既存ID:
- B30101-001
```

### 2. `.claude/skills/task-file-format.md`
**変更内容**: 新タスクタイプとファイル形式の追加

タスクタイプ表の更新:
```
| タスクタイプ | ID形式 | 配置場所 | worktree |
|------------|-------|---------|----------|
| game-dev | `30XXX` | `project/tasks/` | ✅ 有効 |
| bugfix | `B30XXX-NNN` | `project/tasks/` | ✅ 有効 |
| refactor | `R30XXX-NNN` | `project/tasks/` | ✅ 有効 |
| project-wide | `PXXX` | `project/tasks/` | ❌ 無効 |
| framework | `FXXX` | `tasks/` | ❌ 無効 |
```

Frontmatter拡張:
```yaml
---
id: "B30101-001"
title: "着地判定バグ修正"
type: "bugfix"              # bugfix | refactor
related_task: "30101"       # 元の機能タスクID（必須）
status: "todo"
# ... 他のフィールド
---
```

ファイル命名規則追加:
```
B30101-001-着地判定バグ修正.md
R30101-001-ジャンプ処理最適化.md
```

### 3. `.claude/agents/task-registration-agent.md`
**変更内容**: タスクタイプ判定ロジックの拡張

Phase 2 のタスクタイプ判定に追加:
```markdown
4. **Level 1b: プラン内のキーワード検出**
   - "バグ修正", "bug fix", "不具合" → bugfix
   - "リファクタ", "最適化", "改善" → refactor
   - 元タスクID（30XXX）の記載を検出 → related_task に設定

5. **Level 2b: ユーザー確認（バグ/リファクタの場合）**
   - 「元の機能タスクIDを指定してください」
   - 指定されたIDを related_task に設定
```

Phase 3 のID採番に追加:
```markdown
# バグ修正タスクの場合
Skill(skill="id-next", args="B30101")  # → B30101-001

# リファクタタスクの場合
Skill(skill="id-next", args="R30101")  # → R30101-001
```

### 4. `docs/reference/framework-spec.md`
**変更内容**: 番号体系セクションにタスクID体系を追加

タスクID体系セクションを新規追加（番号体系セクション内）:
```markdown
### タスクID体系

| タイプ | 形式 | 例 | 説明 |
|--------|------|-----|------|
| 機能実装 | `30XXX` | 30101 | 新機能の実装 |
| バグ修正 | `B30XXX-NNN` | B30101-001 | 既存機能のバグ修正 |
| リファクタ | `R30XXX-NNN` | R30101-001 | 既存機能の改善・最適化 |
| フレームワーク | `FXXX` | F012 | フレームワーク開発 |
| プロジェクト横断 | `PXXX` | P003 | CI/CD、インフラ等 |

**バグ修正/リファクタタスクの利点**:
- 機能IDを消費しない（枯渇防止）
- 元機能との関連が明確（B30101 → 30101）
- 統計・分析が容易（どの機能にバグが多いか）
```

## 実装ステップ

1. [ ] `.claude/commands/id-next.md` - B/Rプレフィックス採番ロジック追加
2. [ ] `.claude/skills/task-file-format.md` - タスクタイプ・命名規則・Frontmatter追加
3. [ ] `.claude/agents/task-registration-agent.md` - 判定・登録フロー追加
4. [ ] `docs/reference/framework-spec.md` - タスクID体系セクション追加
5. [ ] CLAUDE.md の表を更新（タスク種別表）

## 影響範囲

- **worktree対応**: B/Rタスクも game-dev 同様 worktree 有効
- **既存タスク**: 影響なし（後方互換）
- **採番コマンド**: `/id-next B30101` のような引数形式

## Task Type

framework
