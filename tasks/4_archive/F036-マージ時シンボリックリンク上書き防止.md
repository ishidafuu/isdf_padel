---
id: F036
title: マージ時シンボリックリンク上書き防止
type: framework
status: done
priority: high
created: 2025-01-07
---

# F036: マージ時シンボリックリンク上書き防止

## 概要

worktree をマージする際、worktree 側の `project/target` シンボリックリンクが MAIN 側に上書きされ、MAIN の `project/target` ディレクトリが自己参照のシンボリックリンクに置き換わる問題を防止する。

## 背景

**発生シナリオ:**
```
MAIN: project/target/ (ディレクトリ・実体)
worktree: project/target → MAIN/project/target (シンボリックリンク)

マージ時にシンボリックリンクが優先される
→ MAIN の target がシンボリックリンクに置き換わる
→ cargo build 失敗（循環参照）
```

## 対象ファイル

- `.claude/agents/session-manager-agent.md`

## 実装内容

### 1. フロー D（スカッシュマージ）の前に手順追加

313行目付近、フロー D の冒頭に「マージ前準備」セクションを追加:

```markdown
**⚠️ マージ前の重要手順（CRITICAL）:**

worktree側の `project/target` シンボリックリンクをマージに含めないようにする:

\```bash
# 各worktreeでシンボリックリンクを削除
for feature in player enemy stage; do
  WORKTREE_PATH="${PARENT_DIR}/${PROJECT_NAME}-${feature}"
  if [ -L "${WORKTREE_PATH}/project/target" ]; then
    rm "${WORKTREE_PATH}/project/target"
    echo "✅ Removed symlink: ${feature}/project/target"
  fi
done
\```

**理由:** シンボリックリンクがマージされると、MAIN の `project/target` ディレクトリが
シンボリックリンクに置き換わり、ビルドが壊れる。
```

### 2. 注意事項セクションの追加

フロー D の末尾（360行目付近）に追記:

```markdown
**⚠️ シンボリックリンクに関する注意:**
- worktree の `project/target` は MAIN へのシンボリックリンク
- マージ前に必ず削除すること（上記「マージ前の重要手順」参照）
- 削除を忘れると MAIN の target が壊れる
```

## 完了条件

- [x] session-manager-agent.md にマージ前準備手順を追加
- [x] 注意事項を明文化
- [x] コミット完了

## 参照

- プランファイル: `~/.claude/plans/vectorized-brewing-lake.md`
