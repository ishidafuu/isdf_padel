---
id: "F018"
title: "安全な自動承認設定の導入"
type: "framework"
status: "done"
priority: "medium"
spec_ids: []
blocked_by: []
blocks: []
branch_name: null
worktree_path: null
plan_file: "/Users/s13219/.claude/plans/graceful-doodling-bee.md"
tags: ["security", "hooks", "settings"]
created_at: "2026-01-04T09:30:00+09:00"
updated_at: "2026-01-04T09:30:00+09:00"
completed_at: null
---

# Task F018: 安全な自動承認設定の導入

## 説明

`--dangerously-skip-permissions` を使用する際でも、PreToolUse フックで危険なコマンドを事前にブロックすることで安全性を確保する。

参照記事: https://wasabeef.jp/blog/claude-code-secure-bash

## 背景

### 現状

- `~/.claude/settings.json` に allow/deny パターンは設定済み
- `PreToolUse` フックは未設定
- `~/.claude/scripts/` ディレクトリは存在しない

### 改修理由

- `--dangerously-skip-permissions` で高速実行したいが、危険なコマンドは防ぎたい
- deny パターンだけでなく、フックによる二重チェックで安全性を向上

## 実装内容

- [x] scripts ディレクトリ作成（`~/.claude/scripts/`）
- [x] deny-check.sh 作成（PreToolUse フック用スクリプト）
- [x] settings.json 更新
  - [x] deny パターン 12個追加
  - [x] PreToolUse フック追加
- [x] 実行権限付与
- [x] 動作確認

## 対象ファイル

| ファイル | 操作 |
|---------|------|
| `~/.claude/scripts/deny-check.sh` | 新規作成 |
| `~/.claude/settings.json` | 更新 |

## メモ

- `jq` コマンド必要 → インストール済み（v1.8.1）
- 既存の Notification/Stop フックは維持

## 依存関係

- **ブロック**: なし
- **ブロックされる**: なし
- **関連ドキュメント**: なし

---

## Detailed Implementation Plan

以下は、プランファイル `~/.claude/plans/graceful-doodling-bee.md` の全内容です。

# 安全な自動承認設定の導入

## 背景

参照記事: https://wasabeef.jp/blog/claude-code-secure-bash

`--dangerously-skip-permissions` を使用する際でも、PreToolUse フックで危険なコマンドを事前にブロックすることで安全性を確保する。

## 現状

### 既存設定（~/.claude/settings.json）

```json
{
  "permissions": {
    "allow": [...],  // 22パターン
    "deny": [...]    // 10パターン
  },
  "hooks": {
    "Notification": [...],  // 権限要求時通知
    "Stop": [...]           // 実行完了時通知
  }
}
```

- `PreToolUse` フックは未設定
- `scripts/` ディレクトリは存在しない

## 実装計画

### Step 1: スクリプトディレクトリ作成

```bash
mkdir -p ~/.claude/scripts
```

### Step 2: deny-check.sh 作成

`~/.claude/scripts/deny-check.sh` を作成

**機能:**
- JSON入力からツール名とコマンドを抽出（jq使用）
- settings.json の deny パターンと照合
- 複合コマンド（`;`, `&&`, `||`）を分割してチェック
- マッチ時は exit 2 でブロック

### Step 3: settings.json 更新

### deny パターンレビュー結果

**既存パターン（10個）- 維持:**
| パターン | 目的 | 判定 |
|---------|------|------|
| `Bash(sudo:*)` | ルート権限実行 | ✅ 維持 |
| `Bash(rm -rf:*)` | 再帰削除 | ✅ 維持 |
| `Bash(git reset:*)` | git履歴破壊 | ✅ 維持 |
| `Bash(git rebase:*)` | git履歴改変 | ✅ 維持 |
| `Bash(curl:*)` | 外部通信 | ✅ 維持 |
| `Bash(wget:*)` | 外部通信 | ✅ 維持 |
| `Read(.env.*)` | 機密情報読み取り | ✅ 維持 |
| `Read(id_rsa)` | SSH鍵読み取り | ✅ 維持 |
| `Read(id_ed25519)` | SSH鍵読み取り | ✅ 維持 |
| `Write(.env*)` | 機密情報書き込み | ✅ 維持 |

**追加パターン（12個）:**
| パターン | 目的 | 理由 |
|---------|------|------|
| `Bash(git config:*)` | git設定変更 | ユーザー名・メール等の変更防止 |
| `Bash(git push --force:*)` | force push | リモート履歴破壊防止 |
| `Bash(brew install:*)` | パッケージインストール | システム変更防止 |
| `Bash(chmod 777:*)` | 危険なパーミッション | セキュリティリスク |
| `Bash(gh repo delete:*)` | GitHub破壊操作 | リポジトリ削除防止 |
| `Bash(mkfs:*)` | フォーマット | ディスク破壊防止 |
| `Bash(dd:*)` | ディスク書き込み | ディスク破壊防止 |
| `Bash(npm publish:*)` | npm公開 | 意図しない公開防止 |
| `Bash(shutdown:*)` | シャットダウン | システム停止防止 |
| `Bash(reboot:*)` | 再起動 | システム停止防止 |
| `Bash(launchctl:*)` | サービス管理 | システムサービス変更防止 |
| `Bash(killall:*)` | 全プロセス終了 | 意図しないプロセス停止防止 |

**意図的に追加しないパターン:**
| パターン | 理由 |
|---------|------|
| `Bash(ssh:*)` | 開発作業で必要な場合がある |
| `Bash(pip install:*)` | Python開発で使用（仮想環境内） |
| `Bash(osascript:*)` | 通知フックで使用中 |
| `Bash(open:*)` | ファイル・URL開くのに便利 |
| `Bash(kill:*)` | 個別プロセス終了は許可（killallのみブロック） |

**追加する PreToolUse フック:**
```json
"PreToolUse": [
  {
    "matcher": "Bash",
    "hooks": [
      {
        "type": "command",
        "command": "/Users/s13219/.claude/scripts/deny-check.sh",
        "timeout": 5
      }
    ]
  }
]
```

### Step 4: 実行権限付与

```bash
chmod +x ~/.claude/scripts/deny-check.sh
```

## 対象ファイル

| ファイル | 操作 |
|---------|------|
| `~/.claude/scripts/deny-check.sh` | 新規作成 |
| `~/.claude/settings.json` | 更新 |

## deny-check.sh の実装詳細

```bash
#!/bin/bash

# Claude Code deny-check.sh
# PreToolUse フックで危険なコマンドをブロック

SETTINGS_FILE="$HOME/.claude/settings.json"

# 標準入力からJSONを読み取り
INPUT=$(cat)

# ツール名とコマンドを抽出
TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty')
COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // empty')

# Bash以外はスキップ
if [[ "$TOOL_NAME" != "Bash" ]]; then
    exit 0
fi

# コマンドが空ならスキップ
if [[ -z "$COMMAND" ]]; then
    exit 0
fi

# denyパターンを取得
DENY_PATTERNS=$(jq -r '.permissions.deny[]? | select(startswith("Bash("))' "$SETTINGS_FILE" 2>/dev/null)

# グロブマッチ関数
match_glob() {
    local pattern="$1"
    local text="$2"
    # Bash(xxx:*) 形式からコマンド部分を抽出
    local cmd_pattern="${pattern#Bash(}"
    cmd_pattern="${cmd_pattern%)}"
    # :* を * に変換してグロブマッチ
    cmd_pattern="${cmd_pattern//:*/}"
    [[ "$text" == $cmd_pattern* ]]
}

# 複合コマンドを分割してチェック
IFS=$';\n' read -ra COMMANDS <<< "${COMMAND//&&/$'\n'}"
for cmd in "${COMMANDS[@]}"; do
    cmd=$(echo "$cmd" | sed 's/||/\n/g' | head -1 | xargs)
    for pattern in $DENY_PATTERNS; do
        if match_glob "$pattern" "$cmd"; then
            echo "BLOCKED: Command matches deny pattern: $pattern" >&2
            exit 2
        fi
    done
done

exit 0
```

## 使用方法

**通常モード:**
```bash
claude  # 権限ダイアログあり + PreToolUse でブロック
```

**高速モード:**
```bash
claude --dangerously-skip-permissions  # 権限ダイアログなし + PreToolUse でブロック
```

## 最終的な settings.json（参考）

```json
{
  "env": {},
  "permissions": {
    "allow": [
      "Read(**)",
      "Write(src/**)",
      "Write(docs/**)",
      "Write(.tmp/**)",
      "Bash(git init:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push origin:*)",
      "Bash(git status:*)",
      "Bash(git diff:*)",
      "Bash(git log:*)",
      "Bash(npm install:*)",
      "Bash(pnpm install:*)",
      "Bash(rm:*)",
      "Bash(ls:*)",
      "Bash(cat:*)",
      "mcp__context7__resolve-library-id",
      "mcp__context7__get-library-docs"
    ],
    "deny": [
      "Bash(sudo:*)",
      "Bash(rm -rf:*)",
      "Bash(git reset:*)",
      "Bash(git rebase:*)",
      "Bash(git config:*)",
      "Bash(git push --force:*)",
      "Bash(brew install:*)",
      "Bash(chmod 777:*)",
      "Bash(gh repo delete:*)",
      "Bash(mkfs:*)",
      "Bash(dd:*)",
      "Bash(npm publish:*)",
      "Bash(shutdown:*)",
      "Bash(reboot:*)",
      "Bash(launchctl:*)",
      "Bash(killall:*)",
      "Read(.env.*)",
      "Read(id_rsa)",
      "Read(id_ed25519)",
      "Write(.env*)",
      "Bash(curl:*)",
      "Bash(wget:*)"
    ]
  },
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "/Users/s13219/.claude/scripts/deny-check.sh",
            "timeout": 5
          }
        ]
      }
    ],
    "Notification": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "/Users/s13219/.claude/hooks/permission-requested.sh",
            "timeout": 5
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "/Users/s13219/.claude/hooks/execution-complete.sh",
            "timeout": 5
          }
        ]
      }
    ]
  },
  "statusLine": {
    "type": "command",
    "command": "/Users/s13219/.claude/statusline.sh"
  },
  "model": "opus"
}
```

## 注意事項

- `jq` コマンドが必要 → ✅ インストール済み（v1.8.1）
- フックのタイムアウトは 5秒（十分な余裕）
- 既存の `Notification`/`Stop` フックはそのまま維持
- PreToolUse フックは `--dangerously-skip-permissions` 使用時も有効

## 実装手順まとめ

1. `mkdir -p ~/.claude/scripts`
2. `~/.claude/scripts/deny-check.sh` を作成（上記スクリプト）
3. `chmod +x ~/.claude/scripts/deny-check.sh`
4. `~/.claude/settings.json` を更新（deny パターン追加 + PreToolUse フック追加）
5. Claude Code を再起動して設定を反映
