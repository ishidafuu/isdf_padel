# 77202: QA Review Skill Specification

**Version**: 1.0.0
**Status**: Draft
**Last Updated**: 2026-01-16

## 概要

Claude Codeスキルとして `/qa-review` コマンドを実装。LLMを活用してゲームプレイの違和感を検出し、物理的妥当性・AI挙動・プレイヤー体験の観点からレビューを行う。

## 目的

- TITANアーキテクチャの「Diagnostic Oracle」に相当する機能
- 「なんとなく変」「不自然」といったルールで定義しづらい問題の検出
- 開発者へのフィードバックレポート生成

## 関連仕様

- 77200: テレメトリ拡張仕様
- 77201: ナラティブ変換仕様

## スキルインターフェース

### 基本使用法

```bash
# ナラティブファイルをレビュー
/qa-review report.md

# 直接JSONLをレビュー（内部でナラティブ変換）
/qa-review --trace trace.jsonl

# 特定観点のみ
/qa-review report.md --focus physics
/qa-review report.md --focus ai
/qa-review report.md --focus ux
```

### オプション

| オプション | 説明 |
|-----------|------|
| `--trace <file>` | JSONLファイルを直接指定（ナラティブ変換を自動実行） |
| `--focus <type>` | レビュー観点を絞る（physics/ai/ux/all） |
| `--threshold <level>` | レポートする問題の最低重要度（critical/major/minor） |
| `--output <file>` | レポートをファイルに保存 |

## レビュー観点

### 1. 物理的妥当性（physics）

**チェック項目**:

| 項目 | 期待値 | 異常条件 |
|------|--------|---------|
| サーブ速度 | 80-150 km/h | 範囲外 |
| 通常ショット速度 | 30-100 km/h | 範囲外 |
| バウンス後速度減衰 | 20-40% | 範囲外 |
| 壁反射角度 | 入射角≈反射角 | 差>30° |
| スピン効果 | 速度・スピン値に比例 | 不一致 |

**プロンプト例**:
```
以下のテニスゲームログの物理挙動を確認してください。

期待される物理法則:
- バウンス時は速度が20-40%減衰
- 壁反射は入射角≈反射角
- スピンは曲がり量に影響

異常があれば、フレーム番号と理由を報告してください。
```

### 2. AI行動の自然さ（ai）

**チェック項目**:

| 項目 | 期待値 | 異常条件 |
|------|--------|---------|
| 反応時間 | 0.1-0.5秒 | 範囲外 |
| 移動パターン | 滑らか | 急激な方向転換 |
| 目標位置 | ボール軌道に適切 | 明らかに不適切 |
| 待機位置 | 動的に調整 | 固定位置 |
| 難易度一貫性 | 設定通り | 急に強く/弱くなる |

**プロンプト例**:
```
以下のテニスゲームログでAIの挙動を確認してください。

このAIは「中級者」設定です:
- 反応時間: 0.2-0.4秒
- 適度なミスをする
- 人間らしい動き

以下の観点で不自然な点がないか確認してください:
1. 超人的な反応や到達
2. 不自然に遅い反応
3. 急激な方向転換
4. 明らかに最適でない選択
```

### 3. プレイヤー体験（ux）

**チェック項目**:

| 項目 | 期待値 | 異常条件 |
|------|--------|---------|
| ラリー長 | 3-15ショット | 極端に短い/長い |
| 得点パターン | 多様 | 同じ理由ばかり |
| 判定 | 明確 | 際どいものが多すぎ |
| フラストレーション | 低い | 理不尽な挙動 |

**プロンプト例**:
```
以下のテニスゲームログをプレイヤー視点で評価してください。

確認したい点:
1. ラリーの長さは適切か（短すぎ/長すぎ）
2. ポイントの取られ方は納得感があるか
3. 「え？なんで？」と思う瞬間はないか
4. 不公平に感じる判定はないか
5. ゲームとして面白そうか
```

## 出力形式

### レポート構造

```markdown
# QA Review Report

**File**: report.md
**Reviewed**: 2026-01-16 15:30:00
**Focus**: all

## Summary

| Severity | Count |
|----------|-------|
| Critical | 1 |
| Major | 3 |
| Minor | 5 |

## Issues

### [CRITICAL] 壁抜けバグ

- **Frame**: 1234
- **Category**: physics
- **Description**: ボールが壁を貫通している
- **Evidence**: position: (12.5, 0.5, -8.2) → (-0.3, 0.5, -8.5) (1フレームで12.8m移動)
- **Recommendation**: 壁判定のレイキャストを確認

### [MAJOR] AI反応が超人的

- **Frame**: 2100-2150
- **Category**: ai
- **Description**: ボール到達まで0.05秒で反応開始
- **Evidence**: reaction_timer=0.05, 人間の反応限界は0.1秒
- **Recommendation**: 難易度設定の反応時間下限を確認

### [MINOR] ラリーが短い傾向

- **Frames**: Multiple
- **Category**: ux
- **Description**: 12ラリー中8つが4ショット以内で終了
- **Evidence**: 平均ラリー長: 3.2ショット
- **Recommendation**: AI難易度または物理パラメータを調整

## Overall Assessment

物理演算は概ね正常だが、AI反応速度に調整が必要。
ゲーム体験としてはラリーが短く、もう少し長いラリーを
楽しめるバランスが望ましい。
```

## Core Requirements (MVP)

### スキル実装

#### REQ-77202-001: スキルファイル作成
**THE SYSTEM SHALL** `.claude/commands/qa-review.md` としてスキルを実装する
- Claude Codeのスキル形式に準拠
- 引数パース処理を含む
**テスト**: `/qa-review --help` でヘルプが表示されることを確認

#### REQ-77202-002: ナラティブ入力処理
**WHEN** マークダウンファイルが指定される
**THE SYSTEM SHALL** ファイル内容を読み込みプロンプトに組み込む
**テスト**: ナラティブファイルを指定してレビューが実行されることを確認

#### REQ-77202-003: JSONLからの変換
**WHEN** `--trace` オプションでJSONLが指定される
**THE SYSTEM SHALL** 内部でtrace_narratorを呼び出してナラティブに変換する
**テスト**: JSONLファイル指定でレビューが実行されることを確認

### レビュー実行

#### REQ-77202-004: 物理チェック
**WHEN** `--focus physics` または `--focus all`
**THE SYSTEM SHALL** 物理的妥当性のチェックを実行する
- 速度範囲
- バウンス減衰
- 反射角度
**テスト**: 異常な物理値がレポートされることを確認

#### REQ-77202-005: AIチェック
**WHEN** `--focus ai` または `--focus all`
**THE SYSTEM SHALL** AI行動の自然さをチェックする
- 反応時間
- 移動パターン
- 難易度一貫性
**テスト**: 不自然なAI行動がレポートされることを確認

#### REQ-77202-006: UXチェック
**WHEN** `--focus ux` または `--focus all`
**THE SYSTEM SHALL** プレイヤー体験をチェックする
- ラリー長
- 得点パターン
- フラストレーション要因
**テスト**: UX問題がレポートされることを確認

### 出力

#### REQ-77202-007: マークダウンレポート出力
**THE SYSTEM SHALL** 構造化されたマークダウンレポートを出力する
- Summary（重要度別カウント）
- Issues（詳細）
- Overall Assessment
**テスト**: 有効なマークダウンが出力されることを確認

## Extended Requirements

### REQ-77202-101: 自動実行モード
**WHEN** ヘッドレスシミュレーション終了後
**THE SYSTEM SHALL** 自動的にQAレビューを実行する
- 設定で有効/無効を切替

### REQ-77202-102: 履歴比較
**WHEN** 前回のレポートが存在する
**THE SYSTEM SHALL** 新規/解決済み問題を識別する

## 実装対象ファイル

| ファイル | 内容 |
|---------|------|
| `.claude/commands/qa-review.md` | スキル定義 |
