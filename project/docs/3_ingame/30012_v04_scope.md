# v0.4 スコープ定義

**Version**: 1.0.0
**Last Updated**: 2026-01-09
**Status**: Draft

---

## 目的

v0.4では、**着地点逆算型弾道システム**を実現し、テニスゲームとして魅力的な軌道を表現します。

固定角度発射から「入力した着地地点に落ちるよう角度・初速を逆算」するシステムに変更します。

---

## 現状の問題

| 問題 | 原因 |
|------|------|
| アウト多発 | 距離に関係なく固定角度で発射 |
| 軌道が魅力的でない | 着地計算なしで感覚頼り |
| 狙った場所に打てない | 入力と着地の関係が不明確 |

---

## 完成定義（Definition of Done）

以下の条件を全て満たすことをv0.4の完成とします：

### 着地地点決定

- [ ] 入力なし時、サービスライン付近・中央に着地
- [ ] 前入力でネット際（ドロップ）に着地
- [ ] 後入力でベースライン際（深い球）に着地
- [ ] 左右入力でサイドライン際に着地

### 弾道逆算

- [ ] 角度主体（5°〜60°）で着地地点に到達
- [ ] スピンによる有効重力変動を考慮
- [ ] 届かない距離では自動で初速を微調整

### 初速調整

- [ ] 球種（フラット/トップスピン/スライス）で初速が変化
- [ ] 遠距離では若干強めの初速
- [ ] 既存のpower属性が反映される

### ズレ計算

- [ ] 精度（accuracy）に応じて着地にズレ発生
- [ ] ミスショット判定との連携

### 入力システム拡張

- [ ] Player2がゲームパッドで移動できる
- [ ] Player2がゲームパッドでジャンプ・ショットできる
- [ ] ゲームパッド未接続時もエラーにならない

### 技術要件

- [ ] 全パラメータが外部データ化されている（TrajectoryConfig, GamepadButtonsConfig）
- [ ] 単体テストが全て通過する

---

## 含む機能（v0.4）

### 200_input_system: ゲームパッド対応

| 機能 | 説明 | REQ-ID |
|------|------|--------|
| ゲームパッド入力 | device_id=1でゲームパッド対応 | REQ-20006-050 |
| 未接続時動作 | InputState更新なし | REQ-20006-051 |
| スティック正規化 | デッドゾーン適用 | REQ-20006-052 |
| ボタンマッピング | GameConfigから設定読み取り | REQ-20006-053 |

### 306_shot_system: 弾道計算

| 機能 | 説明 | REQ-ID |
|------|------|--------|
| 着地地点決定 | 入力から着地座標を計算 | REQ-30605-010〜013 |
| 弾道逆算 | 着地地点から発射パラメータを計算 | REQ-30605-020〜024 |
| 初速調整 | 球種・距離による初速係数 | REQ-30605-030〜033 |
| ズレ計算 | 精度による着地ズレ | REQ-30605-040 |

### パラメータ設定

| パラメータ | デフォルト | 説明 |
|-----------|----------|------|
| landing_margin | 0.5m | コート端からのマージン |
| default_landing_depth | 4.0m | 入力なし時の着地深さ |
| min_launch_angle | 5° | 最小発射角度 |
| max_launch_angle | 60° | 最大発射角度 |
| spin_speed_flat | 1.0 | フラット初速係数 |
| spin_speed_topspin | 0.92 | トップスピン初速係数 |
| spin_speed_slice | 0.88 | スライス初速係数 |
| distance_speed_min | 1.0 | 近距離初速係数 |
| distance_speed_max | 1.15 | 遠距離初速係数 |
| max_landing_deviation | 1.0m | 最大着地ズレ |

---

## 含まない機能（v0.5以降）

### 高度な弾道制御

- ❌ カーブショット（横方向のスピン影響）
- ❌ ロブの自動判定
- ❌ 風の影響

### キャラクター性能

- ❌ キャラ別のショットパラメータ
- ❌ 必殺ショット

### エフェクト

- ❌ 着地予測表示
- ❌ 軌道プレビュー

---

## 実装フェーズ

### Phase 1: パラメータ追加

1. `config.rs`: TrajectoryConfig構造体追加
2. `game_config.ron`: パラメータ値追加
3. `GameConfig`: trajectoryフィールド追加

### Phase 2: システム修正

1. `shot_direction.rs`: 着地計算型に変更
   - 入力→着地座標変換
   - 弾道逆算アルゴリズム
   - 初速係数計算

### Phase 3: テスト

1. 単体テスト追加（TST-30605-XXX）
2. 統合テスト・視覚確認

---

## 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `project/src/resource/config.rs` | TrajectoryConfig, GamepadButtonsConfig追加 |
| `project/assets/config/game_config.ron` | パラメータ追加 |
| `project/src/systems/shot_direction.rs` | 着地計算型に変更 |
| `project/src/systems/gamepad_input.rs` | 新規作成（ゲームパッド入力） |
| `project/src/main.rs` | システム登録、Player2変更 |

---

## テスト項目

### 単体テスト

| テストID | テスト名 | 検証内容 |
|----------|---------|---------|
| TST-30605-001 | test_landing_neutral | 入力なし時、サービスライン付近に着地 |
| TST-30605-002 | test_landing_forward | 前入力でネット際に着地 |
| TST-30605-003 | test_landing_backward | 後入力でベースライン際に着地 |
| TST-30605-004 | test_landing_side | 左右入力でサイドライン際に着地 |
| TST-30605-010 | test_trajectory_angle_range | 発射角度が5°〜60°範囲内 |
| TST-30605-011 | test_trajectory_with_topspin | トップスピン時、有効重力が増加 |
| TST-30605-012 | test_trajectory_with_slice | スライス時、有効重力が減少 |
| TST-30605-020 | test_speed_factor_topspin | トップスピン時、初速が92%に |
| TST-30605-021 | test_speed_factor_slice | スライス時、初速が88%に |
| TST-30605-022 | test_speed_factor_distance | 遠距離時、初速係数が増加 |
| TST-30605-030 | test_landing_deviation | 精度に応じたズレ発生 |

---

## 関連ドキュメント

- [30605_trajectory_calculation_spec.md](306_shot_system/30605_trajectory_calculation_spec.md) - 弾道計算仕様
- [30604_shot_attributes_spec.md](306_shot_system/30604_shot_attributes_spec.md) - ショット属性仕様
- [30401_trajectory_spec.md](304_ball/30401_trajectory_spec.md) - ボール軌道仕様
- [80101_game_constants.md](../8_data/80101_game_constants.md) - ゲーム定数

---

## 備考

- v0.3で実装済みのスピン軌道影響はそのまま使用
- 弾道逆算は放物線公式を使用（スピンによる有効重力を考慮）
- 角度で調整しきれない場合のみ初速を微調整（テニス的アプローチ）

---

## Change Log

### 2026-01-09 - v1.0.0（初版）

- v0.4スコープ定義
- 着地点逆算型弾道システムの範囲定義
- パラメータ設定の明確化
