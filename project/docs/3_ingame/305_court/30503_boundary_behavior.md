# Boundary Behavior

**Version**: 2.0.0
**Status**: Draft
**Last Updated**: 2026-01-09

## 概要

コート境界におけるプレイヤーとボールの動作を定義します。テニスはオープンコート（壁・天井なし）であり、プレイヤーはコート外〜外壁まで移動可能、ボールはコートライン外に着地するとアウトとなります。

## 動作定義（EARS記法）

### BEH-30503-001: プレイヤーの外壁制限（コート幅方向）
**WHEN** プレイヤーが外壁（コート幅方向）に到達する
**THE SYSTEM SHALL** プレイヤーの移動を停止させる
- Position.Z を外壁の座標に制限
- Velocity.Z = 0（壁方向の速度成分を0に）
- 外壁位置: Z = ±`config.Court.OuterWallZ`

**備考**: プレイヤーはサイドライン外〜外壁まで自由に移動可能
**参照**: config.Court.OuterWallZ
**テスト**: TST-30504-011

---

### BEH-30503-002: プレイヤーの外壁制限（打ち合い方向）
**WHEN** プレイヤーが外壁（打ち合い方向）に到達する
**THE SYSTEM SHALL** プレイヤーの移動を停止させる
- Position.X を外壁の座標に制限
- Velocity.X = 0（壁方向の速度成分を0に）
- 外壁位置（1P側）: X = `-config.Court.OuterWallX`
- 外壁位置（2P側）: X = `+config.Court.OuterWallX`

**備考**: プレイヤーはベースライン外〜外壁まで自由に移動可能
**参照**: config.Court.OuterWallX
**テスト**: TST-30504-012

---

### BEH-30503-003: プレイヤーのネット通過禁止
**WHEN** プレイヤーがネットに接触する
**THE SYSTEM SHALL** プレイヤーの移動を停止させる
- Position.X を自コート側に制限
- 1Pの場合: Position.X < 0（ネットより手前、画面左側）
- 2Pの場合: Position.X > 0（ネットより奥、画面右側）

**備考**: プレイヤーは相手コートに入れない
**テスト**: TST-30504-013

---

### BEH-30503-004: ボールのアウト判定
**WHEN** ボールが地面（Y = 0）に着地する
**THE SYSTEM SHALL** コートライン境界を判定する
- サイドアウト: |Position.Z| > `config.Court.Width / 2`
- ベースラインアウト: |Position.X| > `config.Court.Depth / 2`

**AND IF** アウト条件を満たす
**THE SYSTEM SHALL** `BallOutEvent` を発行する

**備考**: 空中のボールはアウト判定対象外
**参照**: [30501_court_spec.md](30501_court_spec.md#req-30501-007)
**テスト**: TST-30504-014

---

### BEH-30503-005: ボールのネット接触判定
**WHEN** ボールがネット位置を通過する
**AND** ボールの高さがネット高さ未満である
**THE SYSTEM SHALL** ネット直撃失点を判定する
- 接触条件: |Position.X| < 0.1m かつ Position.Y < 0.88m

**AND THE SYSTEM SHALL** `NetHitEvent` を発行する

**テスト**: TST-30504-015

---

### BEH-30503-006: ボールのコート区分判定
**WHEN** ボールがバウンドする
**THE SYSTEM SHALL** ボールがどちらのコートにいるかを判定する
- 1Pコート: Position.X < 0（画面左側）
- 2Pコート: Position.X >= 0（画面右側、ネット上含む）

**備考**: ツーバウンド判定に使用
**テスト**: TST-30504-016

---

### BEH-30503-007: 境界チェックの優先順位
**WHILE** 境界判定を実行する
**THE SYSTEM SHALL** 以下の順序で判定する
1. ネット接触（失点判定優先）
2. 地面接触（バウンド判定・アウト判定）
3. 外壁接触（即アウト判定）

**備考**: 1フレームで複数接触する場合の処理順序
**テスト**: TST-30504-017

---

### BEH-30503-008: ボールの外壁接触（即アウト）
**WHEN** ボールが外壁に接触する（空中を含む）
**THE SYSTEM SHALL** 即座にアウト判定を行う
- 外壁接触はコートライン着地を待たずにアウト確定

**AND THE SYSTEM SHALL** `BallOutEvent` を発行する
- OutType: 外壁アウト

**備考**: 観客席に飛んだボールは即アウト
**テスト**: TST-30504-018

---

## 制約（Design by Contract）

### 事前条件
- プレイヤーおよびボールの Position が有効な座標
- config.Court.* パラメータが正しく設定されている

### 事後条件
- プレイヤーは常に外壁内に存在する
- ボールはアウト判定またはネット失点により、適切に処理される

### 不変条件
- プレイヤーの Position.Z は `[-OuterWallZ, +OuterWallZ]` の範囲内
- プレイヤーの Position.X は自コート側の外壁内
- プレイヤーの Position.Y は `[0, ∞]` の範囲（オープンコート）

---

## データ参照

| パラメータ | データソース | デフォルト値 |
|----------|------------|------------|
| Court.Width | config.Court.Width | 10.0m |
| Court.Depth | config.Court.Depth | 6.0m |
| Court.OuterWallZ | config.Court.OuterWallZ | 8.0m |
| Court.OuterWallX | config.Court.OuterWallX | 5.0m |

詳細: [80101_game_constants.md](../../8_data/80101_game_constants.md#court-config)

---

## 依存関係

### 依存先
- [30501_court_spec.md](30501_court_spec.md) - コート境界定義・アウト境界定義
- [80101_game_constants.md](../../8_data/80101_game_constants.md) - ゲーム定数

### 依存元
- プレイヤー移動システム（302_player）- プレイヤー移動制限
- ボール物理システム（304_ball）- アウト判定

---

## 備考

### テニスの特徴
- オープンコート（壁・天井なし）
- プレイヤーはコート外〜外壁まで自由に移動可能（ボールを追いかける）
- コートライン外に着地したボールはアウト
- 外壁に直接当たったボールは即アウト

### 削除されたパデル仕様
- 壁反射処理（ボールが壁で反射）→ アウト判定に変更
- 天井反射処理 → 削除（オープンコート）
- プレイヤーのコート内制限 → 外壁まで移動可能に変更

### 3層構造
```
外壁 ─────────────────────────────────
      アウトコート（プレイヤー移動可能）
コートライン ─────────────────────────
      コート内（インプレー）
コートライン ─────────────────────────
      アウトコート（プレイヤー移動可能）
外壁 ─────────────────────────────────
```

---

## Change Log

### 2026-01-09 - v2.0.0（テニスへ変更）

- **概要**: 「ボールは壁で反射」→「コートライン外はアウト」
- **BEH-30503-001, 002**: プレイヤー壁制限 → 外壁制限に変更（コート外移動可能）
- **BEH-30503-003**: ネット通過禁止をX軸基準に修正
- **BEH-30503-004**: ボールの壁反射判定 → アウト判定に変更
- **BEH-30503-005**: ネット接触判定をX軸基準に修正
- **BEH-30503-006**: コート区分判定をX軸基準に修正
- **BEH-30503-007**: 境界チェック優先順位から壁反射削除、アウト判定追加
- **BEH-30503-008**: 新規追加（外壁接触即アウト）

### 2025-12-23 - v1.0.0（初版）

- 初版作成（パデルベース）
