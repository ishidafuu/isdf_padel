# 30048: サーブ弾道統合

## 概要

サーブの弾道計算を固定値方式から着地点逆算型に統合し、ショットシステムと共通化する。

## 背景

- B30102-002で問題特定: サーブ後にShotEvent発行 → shot_direction_systemがラリー用計算で上書き
- 現状サーブは固定値（速度10m/s、角度-15度）でハードコーディング
- ショットシステムは着地点逆算型で高度な弾道計算
- 将来のスピン対応を見据え、統一した仕組みが必要

## 要件

1. **着地点**: 入力で選択可能、サービスボックス内に制限
2. **打点高さ**: トスボールの高さ（1.8m〜2.7m）を使用
3. **スピン**: V0.4ではフラット固定（インターフェースのみ考慮）
4. **オーバーハンドサーブ特性**: 高打点からの下向き発射を自然に表現

## 設計方針

**ShotEventを拡張し、サーブもshot_direction_systemで統一処理**

### ShotEvent拡張

```rust
pub struct ShotEvent {
    // 既存フィールド
    pub player_id: u8,
    pub court_side: CourtSide,
    pub direction: Vec2,
    pub jump_height: f32,
    // 新規追加
    pub is_serve: bool,              // サーブかどうか
    pub hit_position: Option<Vec3>,  // 打点位置（サーブ時のみ）
}
```

### 処理フロー変更

**Before:**
```
serve.rs: 弾道計算 → ボール生成 → ShotEvent発行（未使用）
```

**After:**
```
serve.rs: ShotEvent発行（is_serve=true, hit_position=トス位置）
    ↓
shot_direction_system: サーブ判定 → サービスボックス制限付き着地点計算 → 弾道逆算 → ボール生成
```

## 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `project/src/core/events.rs` | ShotEventに`is_serve`, `hit_position`追加 |
| `project/src/systems/serve.rs` | 弾道計算・ボール生成削除、ShotEvent拡張 |
| `project/src/systems/ai_serve.rs` | 弾道計算・ボール生成削除、ShotEvent拡張 |
| `project/src/systems/shot_input.rs` | ShotEventに`is_serve: false`追加 |
| `project/src/systems/ai_shot.rs` | ShotEventに`is_serve: false`追加 |
| `project/src/systems/trajectory_calculator.rs` | `calculate_serve_landing_position`追加 |
| `project/src/systems/shot_direction.rs` | サーブ判定分岐・ボール生成追加 |
| `project/src/systems/fault_judgment.rs` | ServiceBox/get_service_boxをpub化 |

## 仕様書更新

| ファイル | 変更内容 |
|---------|---------|
| `30102_serve_spec.md` | 弾道計算の参照先を30605に変更、サービスボックス制限追加 |
| `30605_trajectory_calculation_spec.md` | サーブ用着地点計算（REQ-30605-050〜）追加 |
| `30602_shot_direction_spec.md` | ShotEvent拡張、サーブ処理フロー追加 |

## 検証方法

1. `cargo build` 成功
2. `cargo test` パス
3. 動作確認:
   - サーブ入力 → トスボール生成 → ヒット → ボールがサービスボックス内に着地
   - 入力方向で着地点が変化
   - 高打点から自然に下向きに発射
   - AIサーブも同様に動作

## 依存関係

- 前提: B30102-002 完了（サーブシステム実行順序修正）
- 関連: 30043 着地点逆算型弾道システム
- 関連: 30047 サーブv04トスヒット方式

## 将来対応（スコープ外）

- サーブへのスピン対応
- サーブ種別選択UI
