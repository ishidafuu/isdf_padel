---
id: "R30901-001"
title: "point_judgment.rsのunwrap安全化"
type: "refactor"
status: "done"
priority: "high"
related_task: "30019"
spec_ids: ["30901"]
blocked_by: []
blocks: []
branch_name: "task/R30901-001-unwrap-safety"
worktree_path: "../isdf_padel-R30901-001"
plan_file: null
tags: ["systems", "safety", "unwrap", "audit"]
parent_task_id: null
created_at: "2026-01-08T00:00:00"
updated_at: "2026-01-08T00:00:00"
completed_at: null
---

# Task R30901-001: point_judgment.rsテストコードのエラーメッセージ明確化

## Summary

audit-agent による監査で検出された `unwrap()` 使用箇所の改善。
調査の結果、5箇所は全て**テストコード内**であり、本番コードは元から `if let Some/Ok` で安全に処理されていた。

テストコードの `unwrap()` を `expect()` に置換し、テスト失敗時のエラーメッセージを明確化。

## 変更箇所（テストコード内）

| 行 | テスト関数 | 変更内容 |
|----|-----------|----------|
| 477 | `test_req_30103_001_two_bounce_loss` | `unwrap()` → `expect("last_court_side should be set after record_bounce")` |
| 503 | `test_req_30103_003_own_court_hit` | `unwrap()` → `expect("last_shooter.side should be set after record")` |
| 538 | `test_wall_hit_out_judgment` | 同上 |
| 574 | `test_req_30901_001_sideline_out` | 同上 |
| 601 | `test_req_30901_001_baseline_out` | 同上 |

## 本番コードの状況

本番コード（行1-378）は元から安全に実装されていた：
- `if let Some(court_side) = bounce_count.last_court_side` (行76)
- `if let Some(shooter) = last_shooter.side` (行116, 173, 305, 356)
- `if let Ok(...)` でクエリ結果を安全に処理

## Related Specifications

- [30901_point_judgment_spec.md](../../docs/3_ingame/309_referee/30901_point_judgment_spec.md)

## 完了チェックリスト

> このタスクは in-review 経由必須

- [x] ビルド成功（`cargo build`）
- [x] テスト全PASS（`cargo test`）
- [x] in-review に移動済み
- [x] レビュー完了

## メモ

- 本番コードは元から安全に実装されていた（`if let Some/Ok` パターン使用）
- テストコードの `expect()` 置換によりデバッグ時のメッセージが明確化
