---
id: "B30201-001"
title: "座標系マッピングバグ修正"
type: "bugfix"
status: "done"
priority: "high"
related_task: "30201"
spec_ids: ["30201", "30601", "30801"]
blocked_by: []
blocks: []
branch_name: "bugfix/B30201-001"
worktree_path: "../isdf_padel-B30201-001"
plan_file: "~/.claude/plans/parallel-wishing-phoenix.md"
tags: ["coordinates", "input", "debug-ui", "bugfix"]
parent_task_id: null
created_at: "2026-01-09T07:50:00+09:00"
updated_at: "2026-01-09T07:50:00+09:00"
completed_at: "2026-01-09T08:05:00+09:00"
---

# Task B30201-001: 座標系マッピングバグ修正

## Summary

座標系のマッピングに2つのバグがあり、以下の問題が発生している:

1. **ショット判定枠（黄色）がプレイヤー位置とズレている**
2. **A/Dキーで見た目上下に移動してしまう**（左右に動くべき）

## 問題の詳細

### 問題1: ショット判定枠の座標変換バグ

**ファイル**: `src/presentation/debug_ui.rs` (行183-184)

```rust
// 現在（バグ）: X/Z軸が逆
let display_x = logical_pos.value.z * WORLD_SCALE;
let display_y = logical_pos.value.x * WORLD_SCALE;
```

### 問題2: 入力マッピングバグ

**ファイル**: `src/systems/human_input.rs` (行31-45)

```rust
// 現在（バグ）
// W/S → movement.x → velocity.x → display_x（画面左右）
// A/D → movement.y → velocity.z → display_y（画面上下）
```

期待動作:
- W/S（上下キー）→ 画面上下
- A/D（左右キー）→ 画面左右

## Related Specifications

- `docs/3_ingame/302_player/30201_movement_spec.md` - 移動システム仕様
- `docs/3_ingame/306_shot/30601_shot_input_spec.md` - ショット入力仕様
- `docs/3_ingame/308_presentation/30801_shadow_spec.md` - 座標変換仕様

## Progress

### Completed

- [x] 問題の調査・特定
- [x] プラン作成

### In Progress

- [x] バグ修正実装

## Next Actions

1. `debug_ui.rs` のショット判定枠座標変換を修正
2. `human_input.rs` の入力マッピングを修正
3. ゲーム起動して動作確認

## Dependencies

- **Blocked By:** なし
- **Blocks:** なし

## Detailed Implementation Plan

### Step 1: debug_ui.rs の修正

```rust
// Before
let display_x = logical_pos.value.z * WORLD_SCALE;
let display_y = logical_pos.value.x * WORLD_SCALE;

// After
let display_x = logical_pos.value.x * WORLD_SCALE;
let display_y = logical_pos.value.z * WORLD_SCALE + logical_pos.value.y * WORLD_SCALE;
```

### Step 2: human_input.rs の修正

```rust
// Before: W/S → movement.x, A/D → movement.y
// After:  W/S → movement.y, A/D → movement.x

// W/S → movement.y（画面上下=論理Z）
if keyboard.pressed(keys.move_up) || keyboard.pressed(keys.move_up_alt) {
    movement.y += 1.0;
}
if keyboard.pressed(keys.move_down) || keyboard.pressed(keys.move_down_alt) {
    movement.y -= 1.0;
}
// A/D → movement.x（画面左右=論理X）
if keyboard.pressed(keys.move_left) || keyboard.pressed(keys.move_left_alt) {
    movement.x -= 1.0;
}
if keyboard.pressed(keys.move_right) || keyboard.pressed(keys.move_right_alt) {
    movement.x += 1.0;
}
```

### Step 3: コメント修正

`human_input.rs` のコメントを実装と一致させる

## 完了チェックリスト

> このタスクは in-review 経由必須

- [x] ビルド成功（`cargo build`）
- [x] テスト全PASS（`cargo test`）- 135テスト
- [ ] ゲーム起動して動作確認
  - [ ] 黄色いショット判定枠がプレイヤー位置と一致
  - [ ] A/Dキーで左右に移動
  - [ ] W/Sキーで上下に移動
- [x] in-review に移動済み
- [ ] レビュー完了

## メモ

- `sync_transform_system` (presentation/mod.rs) の座標変換が正しい参照実装
- 影の座標変換 (`sync_shadow_system`) も正しく実装されている
