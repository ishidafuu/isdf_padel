---
id: "R30000-005"
title: "長い関数の分割"
type: "refactor"
status: "todo"
priority: "medium"
related_task: null
spec_ids: []
blocked_by: []
blocks: []
branch_name: null
worktree_path: null
plan_file: null
tags: ["refactor", "code-quality", "long-function", "audit"]
parent_task_id: null
audit_source: "2026-01-08"
severity: "major"
category: "code-quality"
created_at: "2026-01-08T15:02:53+09:00"
updated_at: "2026-01-08T15:02:53+09:00"
completed_at: null
---

# Task R30000-005: 長い関数の分割

## Summary

コード監査で検出された50行超の長い関数（26件）を分割し、可読性・保守性を向上させる。

## 検出された問題

### 優先度: High（100行超）

| ファイル | 行 | 関数名 | 行数 |
|----------|-----|-------------------------------|------|
| src/systems/shot_direction.rs | 29 | shot_direction_system | 385 |
| src/systems/scoring.rs | 173 | score_display_system | 334 |
| src/systems/boundary.rs | 36 | player_boundary_system | 307 |
| src/systems/ball_trajectory.rs | 152 | ball_out_of_bounds_system | 278 |
| src/systems/ball_collision.rs | 31 | ball_player_collision_system | 212 |
| src/systems/fault_judgment.rs | 230 | double_fault_processing_system | 201 |
| src/systems/shot_attributes.rs | 317 | build_shot_context_from_input_state | 180 |
| src/systems/point_judgment.rs | 261 | own_court_hit_judgment_system | 179 |
| src/core/court.rs | 161 | determine_court_side | 152 |
| src/systems/serve.rs | 19 | serve_execute_system | 141 |
| src/systems/movement.rs | 21 | movement_system | 136 |
| src/systems/ai_movement.rs | 17 | ai_movement_system | 132 |
| src/systems/ai_shot.rs | 18 | ai_shot_system | 129 |
| src/systems/scoring.rs | 42 | rally_end_system | 118 |
| src/systems/knockback.rs | 140 | knockback_timer_system | 113 |
| src/systems/shot_input.rs | 21 | shot_input_system | 103 |
| src/presentation/visual_feedback.rs | 77 | ball_spin_color_system | 100 |

### 優先度: Medium（50-100行）

| ファイル | 行 | 関数名 | 行数 |
|----------|-----|-------------------------------|------|
| src/systems/shot_attributes.rs | 173 | calculate_shot_attributes | 95 |
| src/systems/human_input.rs | 12 | human_input_system | 78 |
| src/systems/jump.rs | 128 | ceiling_collision_system | 65 |
| src/systems/fault_judgment.rs | 68 | get_service_box | 63 |
| src/systems/knockback.rs | 77 | knockback_movement_system | 63 |
| src/systems/knockback.rs | 15 | knockback_start_system | 62 |
| src/systems/shot_input.rs | 124 | shot_cooldown_system | 60 |
| src/systems/point_judgment.rs | 207 | net_fault_judgment_system | 54 |
| src/systems/fault_judgment.rs | 131 | serve_landing_judgment_system | 54 |

**深刻度**: MAJOR（保守性に重大な影響）

## 修正方針

1. **ヘルパー関数への抽出**
   - 繰り返しロジックをプライベート関数に抽出
   - 条件分岐の各ブランチを個別関数に分離

2. **責務の分離**
   - 入力検証、計算、出力を別関数に
   - イベント発行を専用関数に

3. **段階的対応**
   - 最も長い関数（300行超）から優先的に対応
   - 機能への影響がないことを確認しながら進める

## Progress

### Completed

（未着手）

## Next Actions

1. `shot_direction_system` (385行) を分析・分割
2. `score_display_system` (334行) を分析・分割
3. `player_boundary_system` (307行) を分析・分割
4. 残りの関数を順次対応

## 完了チェックリスト

> このタスクは in-review 経由必須

- [ ] ビルド成功（`cargo build`）
- [ ] テスト全PASS（`cargo test`）
- [ ] 機能への影響なし（動作確認）
- [ ] in-review に移動済み
- [ ] レビュー完了

## メモ

- 監査で検出: 2026-01-08
- テストを含むファイルはテストも同時にリファクタリング
- 分割後も @spec コメントを適切に維持すること
