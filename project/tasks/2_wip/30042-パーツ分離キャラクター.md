# 30042: パーツ分離キャラクターシステム

## 概要

ジョイメカファイト風のパーツ分離キャラクターシステムを実装する。頭・胴体・手・膝・足が分離したロボットキャラクターを表現し、将来的に他のゲームでも再利用可能な汎用素体として設計する。

## 背景

- 現在のプレイヤーは単一エンティティ・単一スプライト（40×60px矩形）
- ジョイメカファイトのような分離パーツによる表現力向上が目的
- 汎用素体として切り出し可能な設計にする

## 要件

### パーツ構成（8パーツ）

| パーツ | 数 | 説明 |
|--------|---|------|
| Head | 1 | 頭部 |
| Torso | 1 | 胴体 |
| Hand | 2 | 左右の手 |
| Knee | 2 | 左右の膝 |
| Foot | 2 | 左右の足 |

### 技術選定

- **ECS設計**: Bevy Parent/Children（1階層のみ）+ カスタム同期システム
- **アニメーション**: パラメトリック補間（キーフレーム間の位置・回転を線形/イージング補間）
- **データ外部化**: `.ron`ファイルでアニメーション定義

## 実装計画

### Phase 1: MVP（静的表示） ✅ 完了

- [x] `character/mod.rs` - モジュール定義・CharacterPlugin
- [x] `character/components.rs` - PartKind, PartDefinition, PartState, ArticulatedCharacter, CharacterFacing
- [x] `character/bundle.rs` - spawn_articulated_player関数
- [x] `character/systems.rs` - sync_part_transforms_system
- [x] `main.rs` - CharacterPlugin登録、スポーンコード
- [x] 仕様書作成 - `project/docs/3_ingame/310_character/`

### Phase 2: アニメーション基盤 ✅ 完了

- [x] `character/animation.rs` - AnimationId, CharacterAnimationState, CharacterAnimationData
- [x] アセットローダー実装（CharacterAnimationsLoader）
- [x] `assets/animations/character_animations.anim.ron` - Idleアニメーション定義
- [x] advance_animation_system, update_part_states_system 実装
- [x] 仕様書作成（31002_animation_spec.md）

### Phase 3: アニメーション遷移

- [ ] Walk, Jump, Fall, Shot アニメーションデータ
- [ ] アニメーション遷移ロジック
- [ ] update_character_facing_system（向き自動判定）
- [ ] イージング補間対応

### Phase 4: 統合・最適化

- [ ] 影システム統合
- [ ] ふっとばしアニメーション対応
- [ ] 既存PlayerBundleからの移行パス検討
- [ ] ホットリロード対応

## 主要ファイル

| ファイル | 操作 | 説明 |
|---------|------|------|
| `project/src/character/mod.rs` | 新規 | CharacterPlugin定義 |
| `project/src/character/components.rs` | 新規 | パーツComponent定義 |
| `project/src/character/animation.rs` | 新規 | アニメーションデータ構造 |
| `project/src/character/bundle.rs` | 新規 | Bundle定義 |
| `project/src/character/systems.rs` | 新規 | System実装 |
| `project/src/main.rs` | 修正 | CharacterPlugin登録 |
| `project/assets/animations/character_animations.ron` | 新規 | アニメーションデータ |

## 検証方法

1. `cargo build` - ビルド成功
2. `cargo run` - ゲーム起動
3. 目視確認 - 8パーツでキャラクター表示
4. アニメーション確認 - Idleアニメーション再生
5. 操作確認 - 移動/ジャンプ/ショットでアニメーション遷移

## 設計上の注意点

- 既存PlayerBundleは残す（互換性維持）
- ハードコーディング禁止（パーツ定義・アニメーションは.ron外部化）
- ECS原則遵守（Component=データ、System=ロジック）
- 1パーツ=1エンティティ

## 関連ドキュメント

- 計画書: `~/.claude/plans/effervescent-toasting-squirrel.md`
- 参考: ジョイメカファイト（ファミコン、任天堂、1993年）

---

## Progress

### 2026-01-09: Phase 1 MVP 完了

- [x] 仕様書作成（310_character/31000_overview.md, 31001_parts_spec.md）
- [x] character モジュール新規作成（mod.rs, components.rs, bundle.rs, systems.rs）
- [x] CharacterPlugin 実装・登録
- [x] spawn_articulated_player 関数で8パーツキャラクター生成
- [x] sync_part_transforms_system でパーツ位置同期
- [x] ビルド成功・動作確認完了（紫色のパーツ分離キャラクターが表示）

### 2026-01-09: Phase 2 アニメーション基盤 完了

- [x] 31002_animation_spec.md 作成（アニメーション仕様書）
- [x] character/animation.rs 作成（AnimationId, CharacterAnimationState, CharacterAnimationData, Keyframe, CharacterAnimations）
- [x] CharacterAnimationsLoader 実装（.anim.ron ファイル読み込み）
- [x] load_character_animations_system 実装（起動時ロード）
- [x] assets/animations/character_animations.anim.ron 作成（Idleアニメーション定義）
- [x] advance_animation_system 実装（アニメーション時間進行）
- [x] update_part_states_system 実装（キーフレーム補間）
- [x] CharacterAnimationState を spawn_articulated_player に追加
- [x] ビルド成功

### 2026-01-09: Phase 2 動作確認完了

- [x] Idleアニメーション動作確認
- [x] アニメーション振幅を調整（見える大きさに拡大）
- [x] デバッグログ削除、コードクリーンアップ

### 2026-01-09: Phase 3 アニメーション遷移 完了

- [x] Walk, Jump, Fall, Shot アニメーションデータ追加
- [x] update_animation_state_system（自動遷移ロジック）
- [x] trigger_shot_animation_system（ShotEventトリガー）
- [x] update_character_facing_system（向き自動判定）
- [x] パーツ表示優先度と色調整
- [x] ビルド成功・コミット完了

### 2026-01-09: Phase 4 向きを加味したZ優先度 完了

- [x] REQ-31001-007 仕様追加（向きを加味したZ優先度）
- [x] PartKind::is_right() メソッド追加
- [x] sync_part_transforms_system でZ優先度計算を実装
- [x] ビルド成功

### 2026-01-09: Phase 4 P1/P2移行 完了

- [x] P1をspawn_articulated_playerに置き換え（HumanControlled追加）
- [x] P2をspawn_articulated_playerに置き換え（AiController追加）
- [x] テスト用P3キャラクター削除
- [x] PlayerBundle importを削除
- [x] ビルド成功

## Next Actions

1. Phase 4 残り: 統合・最適化
   - 影システム統合
   - ふっとばしアニメーション対応
   - PlayerBundleの削除（不要になった場合）
   - ホットリロード対応

## メモ

- P1/P2がパーツ分離キャラクターに移行完了
- PlayerBundleは未使用（警告発生中）だが後方互換性のため一旦保持
- 仕様書ディレクトリは `310_character/`（309_referee が既存のため）
- アニメーションファイル拡張子は `.anim.ron`
