---
id: "30023"
title: "ショット方向相手コート固定"
type: game-dev
status: todo
priority: high
created: 2025-01-07
spec_refs:
  - "project/docs/3_ingame/306_shot_system/30602_shot_direction_spec.md"
impl_refs:
  - "project/src/game/shot/shot_input.rs"
  - "project/src/game/shot/shot_direction.rs"
---

# 30023: ショット方向相手コート固定

## 概要

ショットの打球方向が常に相手コートに向かうように修正する。現在の実装では移動入力（十字キー）がそのままショット方向に反映されるため、上下に移動しながらショットすると相手コート以外の方向にボールが飛んでしまう問題がある。

## 問題の詳細

### 現状の動作

- プレイヤーの移動入力（十字キー）がそのままショット方向に使われている
- 上下移動中にショットすると、ボールが上下方向に飛ぶ
- ゲームとして成り立たない

### 原因

`shot_input.rs` でプレイヤーの移動入力（`MovementInput`）をそのままショット方向として使用している。

```rust
// 現在の実装（問題）
let raw_direction = match player.id {
    1 => movement_input.player1,  // 入力方向をそのまま使用
    2 => movement_input.player2,
    _ => Vec2::ZERO,
};
```

## 修正方針

REQ-30602-001（仕様書更新済み）に従い：

1. **Z軸方向（前後）: 常に相手コート方向に固定**
   - Player 1: Z正方向（+Z）
   - Player 2: Z負方向（-Z）
   - 上下入力は無視する

2. **X軸方向（左右）: 入力で調整可能**
   - 左右入力がある場合: 入力方向に応じて左右に打ち分け
   - 左右入力がない場合: ストレート（X = 0）

## 実装タスク

### 1. shot_input.rs の修正

`shot_input_system` でShotEventに渡す方向を修正：

```rust
// 修正後
let direction = Vec2::new(
    movement_input.player1.x,  // X軸のみ入力を反映
    0.0,  // Y軸（→Z軸）は後で決定
);
```

### 2. shot_direction.rs の修正

`calculate_horizontal_direction` を修正して、プレイヤーIDに応じてZ軸方向を固定：

```rust
fn calculate_horizontal_direction(direction: Vec2, player_id: u32) -> Vec3 {
    let z_direction = match player_id {
        1 => 1.0,   // Player 1: +Z方向（相手コート）
        2 => -1.0,  // Player 2: -Z方向（相手コート）
        _ => 1.0,
    };

    Vec3::new(direction.x, 0.0, z_direction).normalize()
}
```

## 受け入れ条件

- [ ] Player 1 のショットは常にZ正方向（相手コート）に飛ぶ
- [ ] Player 2 のショットは常にZ負方向（相手コート）に飛ぶ
- [ ] 上下移動中にショットしてもボールは相手コートに飛ぶ
- [ ] 左右入力でショットの左右打ち分けができる
- [ ] 既存のテストが通る

## 関連

- 仕様書: REQ-30602-001（更新済み）
- 元タスク: 30011-打球方向計算
