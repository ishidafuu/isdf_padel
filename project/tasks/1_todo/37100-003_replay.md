# 37100-003: リプレイ機能

## 概要

手元で発生した不具合をAIに伝えて再現・調査させるためのデバッグ用リプレイ機能を実装する。

## 背景

- デバッグ時に「どの入力で不具合が発生したか」を正確に伝える手段がない
- 不具合の再現に時間がかかる
- AIが自律的に不具合を調査できる基盤が必要

## 前提条件

**37100-002（シミュレータ機能強化）完了後に着手**
- Phase 1.4（シード固定）: リプレイ記録時にシード保存
- Phase 2（トレース機能）: ヘッドレス再生時のデバッグ出力

## 主なユースケース

1. **不具合報告**: 手元で発生した不具合のリプレイをAIに渡す
2. **再現確認**: AIがリプレイを再生して不具合を再現
3. **原因調査**: トレース出力で状態遷移を確認
4. **視覚確認**: 画面表示で不具合を目視確認

## 要件

- 対戦形式: 人間 vs AI、将来的に人間 vs 人間
- 記録: 毎試合自動保存
- 保存管理: バージョンアップ時に古いリプレイを削除
- 再生: 画面表示あり + ヘッドレス実行（AI解析用）

## 設計方針

### データ構造

```rust
pub struct ReplayData {
    pub metadata: ReplayMetadata,
    pub frames: Vec<FrameInput>,
}

pub struct ReplayMetadata {
    pub game_version: String,      // バージョン不一致で削除対象
    pub recorded_at: String,       // ISO 8601形式
    pub seed: u64,                 // 乱数シード
    pub initial_serve_side: TeamSide,
}

pub struct FrameInput {
    pub frame: u32,
    pub p1: InputSnapshot,
    pub p2: InputSnapshot,
}

pub struct InputSnapshot {
    pub movement: Vec2,
    pub shot_pressed: bool,
    pub jump_pressed: bool,
    pub holding: bool,
    pub hold_time: f32,
}
```

### ファイル管理

- 保存先: `assets/replays/`
- ファイル名: `replay_{timestamp}.ron`
- 起動時処理:
  1. game_version不一致 → 削除
  2. 保存数上限（100件）超過 → 古い順に削除

### シミュレータ統合

- 共通基盤: `HeadlessPlugins`
- トレース出力: 37100-002 Phase 2と共有
- 入力注入: `ReplayInputProvider`がInputStateを上書き

## サブタスク

### Phase 0: 仕様書作成
- [ ] 仕様書作成 `project/docs/3_features/37100_simulation/37103_replay_spec.md`
  - [ ] EARS記法で要件定義
  - [ ] データ構造、ファイル管理、再生方法を明文化
- [ ] データ定義追加 `project/docs/8_data/`
  - [ ] ReplayMetadata、FrameInput等の外部化パラメータ

### Phase 1: 記録機能
- [ ] Phase 1.1: データ構造定義
  - [ ] `project/src/replay/mod.rs` モジュール定義
  - [ ] `project/src/replay/data.rs` ReplayData, FrameInput等
- [ ] Phase 1.2: 記録システム
  - [ ] `project/src/replay/recorder.rs`
  - [ ] `ReplayRecorder`リソース（全フレーム保持）
  - [ ] `replay_record_system`: 毎フレームInputStateを記録
- [ ] Phase 1.3: 保存機能
  - [ ] `replay_save_system`: 試合終了時に自動保存
  - [ ] RON形式でシリアライズ
- [ ] Phase 1.4: バージョン管理
  - [ ] `project/src/replay/manager.rs`
  - [ ] 起動時に古いバージョンのリプレイを削除
  - [ ] 保存数上限チェック（100件）

### Phase 2: 再生機能（ヘッドレス）
- [ ] Phase 2.1: リプレイ読み込み
  - [ ] `project/src/replay/loader.rs`
  - [ ] RONデシリアライズ
- [ ] Phase 2.2: 入力再生システム
  - [ ] `project/src/replay/player.rs`
  - [ ] `ReplayInputProvider`リソース
  - [ ] `replay_input_system`: 記録データをInputStateに注入
- [ ] Phase 2.3: ヘッドレス再生CLI
  - [ ] `project/src/bin/replay_player.rs`
  - [ ] シミュレータと同じHeadlessPlugins基盤
  - [ ] トレース出力対応（37100-002 Phase 2と統合）

### Phase 3: 画面表示再生
- [ ] Phase 3.1: リプレイモード追加
  - [ ] `AppState::ReplayPlayback`状態追加
  - [ ] 入力ソースをリプレイに切り替え
- [ ] Phase 3.2: リプレイ選択UI
  - [ ] 保存済みリプレイ一覧表示
  - [ ] 選択して再生開始
- [ ] Phase 3.3: 再生コントロール（将来拡張）
  - [ ] 一時停止/再開
  - [ ] 再生速度変更
  - [ ] フレーム送り

## 対象ファイル

### 新規作成
```
project/docs/3_features/37100_simulation/
└── 37103_replay_spec.md     # 仕様書

project/src/replay/
├── mod.rs
├── data.rs          # データ構造
├── recorder.rs      # 記録システム
├── loader.rs        # 読み込み
├── player.rs        # 再生システム
└── manager.rs       # ファイル管理

project/src/bin/
└── replay_player.rs # ヘッドレス再生CLI
```

### 修正対象
```
project/src/lib.rs                    # replayモジュール追加
project/src/states/app_state.rs       # ReplayPlayback状態追加
project/src/systems/human_input.rs    # リプレイモード時の分岐
```

## 検証方法

### Phase 0検証
- 仕様書がEARS記法に準拠していることを確認
- `/ears-validate`でバリデーション

### Phase 1検証
1. 通常プレイで試合終了
2. `assets/replays/`にファイルが生成されることを確認
3. RONファイルの内容が正しいことを確認
4. バージョン変更後、古いリプレイが削除されることを確認

### Phase 2検証
1. `cargo run --bin replay_player -- <replay_file>`
2. トレース出力で元の試合と同じ状態遷移を確認
3. 同じリプレイを複数回再生して同一結果を確認

### Phase 3検証
1. ゲーム内からリプレイ選択
2. 画面表示で元の試合が再現されることを確認

## Progress

- 2026-01-10: タスク作成

## 関連ファイル

- `project/tasks/1_ready/37100-002_simulation_enhancement.md` - 前提タスク
- `project/docs/7_tools/71_simulation/77100_headless_sim.md` - シミュレータ仕様書

## 参照

- プラン: `.claude/plans/jiggly-dancing-ocean.md`
