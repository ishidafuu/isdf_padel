---
id: "P003"
title: "プレイヤー入力システムリファクタリング"
type: "project-wide"
status: "todo"
priority: "medium"
created_at: "2026-01-08"
updated_at: "2026-01-08"
tags: ["architecture", "input", "refactor", "scalability"]
blocked_by: []
blocks: []
---

# P003: プレイヤー入力システムリファクタリング

## 概要

現在のコードベースで `player1_`/`player2_` というハードコーディングが蔓延しており、以下の問題がある：
- ダブルス（4人）に対応不可
- 全員AI / 全員人間の切り替え不可
- プレイヤー数の動的変更不可
- 入力デバイスとプレイヤーの紐付けが固定

## 問題箇所（発見済み）

### 入力系

| ファイル | 問題 |
|---------|------|
| `src/systems/shot_attributes.rs` | `ShotButtonState` に `player1_hold_time`, `player2_hold_time` 等 |
| `src/systems/shot_input.rs` | `ShotInput` に `player1_pressed`, `player2_pressed` |
| `src/systems/jump.rs` | `JumpInput` に `player1_pressed`, `player2_pressed` |
| `src/systems/movement.rs` | `MovementInput` に `player1` 固定 |

### スコアリング系

| ファイル | 問題 |
|---------|------|
| `src/resource/scoring.rs` | `MatchScore` に `player1_score`, `player2_score` 等 |
| `src/systems/scoring.rs` | スコア処理で player1/player2 決め打ち |

### その他

| ファイル | 問題 |
|---------|------|
| `src/presentation/visual_feedback.rs` | プレイヤーIDでホールド状態を参照 |
| `src/main.rs` | プレイヤースポーン時に ID 1, 2 固定 |

## 解決方針

### 1. エンティティベースの入力状態

```rust
// 入力状態はプレイヤーごとのコンポーネントとして保持
#[derive(Component, Default)]
pub struct InputState {
    pub holding: bool,
    pub hold_time: f32,
    pub movement: Vec2,
    pub jump_pressed: bool,
    pub shot_pressed: bool,
}
```

### 2. コントローラー種別のマーカーコンポーネント

```rust
// 人間操作
#[derive(Component)]
pub struct HumanControlled {
    pub device_id: usize,  // キーボード=0, ゲームパッド=1,2,...
}

// AI操作
#[derive(Component)]
pub struct AiControlled {
    pub difficulty: f32,
}
```

### 3. 入力システムの分離

```rust
// 人間入力システム: HumanControlled を持つエンティティの InputState を更新
fn human_input_system(
    keyboard: Res<ButtonInput<KeyCode>>,
    mut query: Query<(&HumanControlled, &mut InputState)>,
) { ... }

// AI入力システム: AiControlled を持つエンティティの InputState を更新
fn ai_input_system(
    mut query: Query<(&AiControlled, &mut InputState), Without<HumanControlled>>,
) { ... }
```

### 4. スコアリングの汎化

```rust
// コートサイド（チーム）ベースのスコア管理
pub struct TeamScore {
    pub points: PlayerPoint,
    pub games: u8,
    pub sets: u8,
}

pub struct MatchScore {
    pub scores: HashMap<CourtSide, TeamScore>,
    // または
    pub scores: [TeamScore; 2],  // シングルス/ダブルス共通
}
```

## 実装タスク

### フェーズ1: 入力システムリファクタリング

1. [ ] `InputState` コンポーネント作成
2. [ ] `HumanControlled` / `AiControlled` マーカー作成
3. [ ] `human_input_system` 実装
4. [ ] `ShotButtonState`, `JumpInput`, `ShotInput`, `MovementInput` を `InputState` に統合
5. [ ] 既存の `track_shot_button_system` 等を移行
6. [ ] AI入力システムとの連携確認

### フェーズ2: スコアリングリファクタリング

1. [ ] `TeamScore` 構造体作成
2. [ ] `MatchScore` をチームベースに変更
3. [ ] スコアリングシステムの更新
4. [ ] デバッグUI更新

### フェーズ3: テスト・検証

1. [ ] 単体テスト追加
2. [ ] 統合テスト（1P vs AI）
3. [ ] 全員AI動作確認

## コーディングルール更新（CRITICAL）

**このタスク完了後、以下のルールを CLAUDE.md / コーディング規約に追加する：**

### 追加ルール案

#### ハードコーディング禁止の拡張

```markdown
### プレイヤー固定参照禁止原則（CRITICAL）

**NEVER hardcode player identifiers like `player1_`, `player2_`, or fixed player IDs.**

```rust
// ❌ 絶対に禁止
pub struct ShotButtonState {
    pub player1_holding: bool,
    pub player2_holding: bool,
}

// ❌ 絶対に禁止
match player.id {
    1 => ...,
    2 => ...,
}

// ✅ 必須: エンティティ/コンポーネントベース
#[derive(Component)]
pub struct InputState {
    pub holding: bool,
    pub hold_time: f32,
}

// ✅ 必須: マーカーコンポーネントで制御種別を区別
#[derive(Component)]
pub struct HumanControlled { pub device_id: usize }

#[derive(Component)]
pub struct AiControlled;
```

**理由**:
- ダブルス対応（4人以上）が不可能になる
- AI/人間の動的切り替えが不可能になる
- プレイヤー数の変更が困難になる
- 入力デバイス割り当ての柔軟性がなくなる

**設計原則**:
- 状態はエンティティごとのコンポーネントで管理
- 制御種別（人間/AI）はマーカーコンポーネントで区別
- リソースは「グローバルに1つしかないもの」にのみ使用
```

### 仕様書への影響

- `20006_input_system.md` の更新が必要
- 新規アーキテクチャ仕様書の作成を検討

## 受け入れ条件

- [ ] `player1_`/`player2_` のハードコーディングが全て除去されている
- [ ] 1P vs AI が正常動作する
- [ ] 全員AIモードが動作する（テスト用）
- [ ] CLAUDE.md にコーディングルールが追加されている
- [ ] 関連仕様書が更新されている

## メモ

- 発見経緯: v0.2統合テスト（30033）でVキー押下時にAI側も色が変わる問題の調査中に発覚
- 現時点では応急処置として `track_shot_button_system` でPlayer2へのコピーを削除済み

## Progress

### Completed

- [x] 問題箇所の特定
- [x] タスク登録

## Next Actions

1. 仕様書（20006_input_system.md）を確認し、設計方針を固める
2. フェーズ1の実装開始
