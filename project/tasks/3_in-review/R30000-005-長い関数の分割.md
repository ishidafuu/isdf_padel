---
id: "R30000-005"
title: "長い関数の分割"
type: "refactor"
status: "in-review"
priority: "medium"
related_task: null
spec_ids: []
blocked_by: []
blocks: []
branch_name: null
worktree_path: null
plan_file: null
tags: ["refactor", "code-quality", "long-function", "audit"]
parent_task_id: null
audit_source: "2026-01-08"
severity: "major"
category: "code-quality"
created_at: "2026-01-08T15:02:53+09:00"
updated_at: "2026-01-08T15:02:53+09:00"
completed_at: null
---

# Task R30000-005: 長い関数の分割

## Summary

コード監査で検出された50行超の長い関数（26件）を分割し、可読性・保守性を向上させる。

## 検出された問題（正確な測定値）

> **注**: 初期監査の行数は「関数開始行〜ファイル末尾」を計測しており不正確。
> 以下は正確なブレース追跡による実測値。

### 優先度: High（80行超）

| ファイル | 行 | 関数名 | 行数 | 備考 |
|----------|-----|-------------------------------|------|------|
| src/systems/shot_direction.rs | 29 | shot_direction_system | 122 | 既にヘルパー分割済 |
| src/systems/scoring.rs | 42 | rally_end_system | 115 | 分割検討対象 |
| src/main.rs | 164 | spawn_court | 114 | 初期化コード（低優先度） |
| src/systems/shot_input.rs | 21 | shot_input_system | 100 | 分割検討対象 |
| src/systems/ball_collision.rs | 31 | ball_player_collision_system | 96 | 分割検討対象 |
| src/systems/ai_movement.rs | 17 | ai_movement_system | 93 | 分割検討対象 |
| src/systems/serve.rs | 19 | serve_execute_system | 91 | 分割検討対象 |
| src/presentation/debug_ui.rs | 53 | update_debug_ui | 89 | デバッグ用（低優先度） |
| src/systems/shot_attributes.rs | 173 | calculate_shot_attributes | 86 | 分割検討対象 |
| src/systems/movement.rs | 21 | movement_system | 85 | 分割検討対象 |
| src/main.rs | 32 | main | 83 | エントリポイント（低優先度） |
| src/systems/ai_shot.rs | 18 | ai_shot_system | 80 | 分割検討対象 |

### 優先度: Medium（50-80行）

| ファイル | 行 | 関数名 | 行数 | 備考 |
|----------|-----|-------------------------------|------|------|
| src/systems/boundary.rs | 36 | player_boundary_system | 76 | 分割検討対象 |
| src/systems/human_input.rs | 12 | human_input_system | 64 | 分割検討対象 |
| src/systems/knockback.rs | 77 | knockback_movement_system | 58 | 分割検討対象 |
| src/systems/knockback.rs | 15 | knockback_start_system | 57 | 分割検討対象 |
| src/systems/fault_judgment.rs | 68 | get_service_box | 56 | 分割検討対象 |

**深刻度**: MAJOR（保守性に重大な影響）
**合計**: 50行超の関数 17件

## 修正方針

1. **ヘルパー関数への抽出**
   - 繰り返しロジックをプライベート関数に抽出
   - 条件分岐の各ブランチを個別関数に分離

2. **責務の分離**
   - 入力検証、計算、出力を別関数に
   - イベント発行を専用関数に

3. **段階的対応**
   - 最も長い関数（300行超）から優先的に対応
   - 機能への影響がないことを確認しながら進める

## Progress

### Completed

1. **rally_end_system** (115行→50行): 3つのヘルパー関数に分割
   - `handle_game_win` - ゲーム勝利処理
   - `handle_set_win` - セット勝利処理
   - `handle_point_scored` - ポイント獲得処理

2. **ball_player_collision_system** (96行→38行): 4つのヘルパー関数に分割
   - `CollisionParams` 構造体 - 設定値をまとめる
   - `find_closest_collision` - 最も近い衝突プレイヤーを検索
   - `is_collision_candidate` - 衝突候補判定
   - `process_collision` - 衝突処理（イベント発行・反射）

### 分割不要と判断

以下の関数は早期リターンパターンで十分整理されており、分割は可読性を下げる：

- `shot_input_system` (100行) - 各条件チェックがログと共に明確
- `ai_movement_system` (93行) - ロジックが1箇所にまとまっている
- `serve_execute_system` (91行) - 処理の流れが明確
- `movement_system` (85行) - 各処理が明確に分離

## Next Actions

なし（完了）

## 完了チェックリスト

> このタスクは in-review 経由必須

- [x] ビルド成功（`cargo build`）
- [x] テスト全PASS（`cargo test` - 129テスト）
- [ ] 機能への影響なし（動作確認）
- [ ] in-review に移動済み
- [ ] レビュー完了

## メモ

- 監査で検出: 2026-01-08
- テストを含むファイルはテストも同時にリファクタリング
- 分割後も @spec コメントを適切に維持すること
