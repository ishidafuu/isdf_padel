---
id: "R30501-001"
title: "Core層レイヤー違反解消（court.rs）"
type: "refactor"
status: "in-review"
priority: "high"
related_task: "30001"
spec_ids: ["30501"]
blocked_by: []
blocks: []
branch_name: null
worktree_path: null
plan_file: null
tags: ["core", "architecture", "layer-violation"]
parent_task_id: null
audit_source: "2026-01-08"
severity: "major"
category: "dependency"
created_at: "2026-01-08T00:00:00+09:00"
updated_at: "2026-01-08T00:00:00+09:00"
completed_at: null
---

# Task R30501-001: Core層レイヤー違反解消（court.rs）

## Summary

`core/court.rs` が `resource::CourtConfig` を参照しており、アーキテクチャ仕様（20001_layers.md）に違反している。
Core層（Layer 1）は依存なしであるべきだが、Resource層（Layer 2）に依存している状態を解消する。

## 検出された問題

- **ファイル**: `project/src/core/court.rs:13`
- **問題コード**: `use crate::resource::CourtConfig;`
- **違反ルール**: `20001_layers.md` - 「Core → 上位レイヤー」は禁止
- **深刻度**: MAJOR

## 影響範囲

- `CourtBounds::from_config(config: &CourtConfig)`
- `NetInfo::from_config(config: &CourtConfig)`
- `Court::from_config(config: &CourtConfig)`

## 修正方針

### オプションA: from_config を Systems 層に移動（採用）

1. `core/court.rs` から `from_config` メソッドを削除
2. Systems 層で `CourtBounds` を生成するファクトリ関数を作成
3. `CourtBounds` 自体は引数のみで生成可能に変更

## Related Specifications

- [30501_court_spec.md](../../docs/3_ingame/305_court/30501_court_spec.md) - コート座標系仕様
- [20001_layers.md](../../docs/2_architecture/20001_layers.md) - レイヤー定義

## Progress

### Completed

1. **from_config呼び出し箇所を特定**
   - Systems層: movement.rs, ball_trajectory.rs, ai_movement.rs, boundary.rs, knockback.rs, point_judgment.rs
   - Core層テスト: court.rs, wall.rs

2. **Core層からResource依存を削除**
   - `core/court.rs`: `use crate::resource::CourtConfig;` を削除
   - `CourtBounds::from_config` → `CourtBounds::new(left, right, back_1p, back_2p, ground, ceiling)`
   - `NetInfo::from_config` → `NetInfo::new(z, height)`
   - `Court::from_config` → `Court::new(bounds, net)`
   - テストも直接値を使うよう修正

3. **Systems層にファクトリ関数を作成**
   - `systems/court_factory.rs` を新規作成
   - `create_court_bounds(config: &CourtConfig) -> CourtBounds`
   - `create_net_info(config: &CourtConfig) -> NetInfo`
   - `create_court(config: &CourtConfig) -> Court`

4. **全呼び出し元を修正**
   - movement.rs, ai_movement.rs, knockback.rs, boundary.rs, ball_trajectory.rs, point_judgment.rs
   - `CourtBounds::from_config` → `create_court_bounds`
   - `NetInfo::from_config` → `create_net_info`
   - `Court::from_config` → `create_court`

5. **ビルド・テスト確認**
   - `cargo build`: 成功
   - `cargo test`: 125テスト全てパス

## Dependencies

- **Blocked By:** なし
- **Blocks:** なし

## 完了チェックリスト

> このタスクは in-review 経由必須

- [x] ビルド成功（`cargo build`）
- [x] テスト全PASS（`cargo test`）
- [x] レイヤー違反が解消されていることを確認
- [x] in-review に移動済み
- [ ] レビュー完了
