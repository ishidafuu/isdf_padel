---
id: "30032"
title: "視覚フィードバック実装"
type: game-dev
status: done
priority: high
created: 2026-01-08
spec_refs:
  - "30802_visual_feedback_spec.md"
  - "30604_shot_attributes_spec.md"
data_refs:
  - "80101_game_constants.md#visual-feedback-config"
---

# 30032: 視覚フィードバック実装

## 概要

v0.2統合テスト・バランス調整のために、ショット属性システムの状態を視覚的に表示する機能を実装する。

## 実装内容

### 1. VisualFeedbackConfig 追加

- `config.rs` に `VisualFeedbackConfig` struct 追加
- GameConfig に `visual_feedback` フィールド追加

### 2. BallSpin コンポーネント追加

- `components/mod.rs` に `BallSpin` コンポーネント追加
- ショット実行時にスピン値を設定

### 3. ホールド構え表示システム

- `ShotButtonState.player1_holding` を参照
- プレイヤースプライトの色を変化させるシステム
- @spec REQ-30802-001, REQ-30802-002

### 4. ボールスピン色変化システム

- `BallSpin` コンポーネントを参照
- ボールスプライトの色をスピン値に応じて変化
- @spec REQ-30802-003, REQ-30802-004, REQ-30802-005

### 5. システム登録

- `main.rs` に新システムを登録

## 受け入れ条件

- [x] プレイヤーがボタンを押し続けると色がオレンジに変化する
- [x] ホールド時間に応じて色が濃くなる
- [x] ボタンを離すと元の色に戻る
- [x] ボールのスピンに応じて色が変化する（赤=トップ、黄=ニュートラル、青=スライス）
- [x] `cargo build` が通る
- [x] `cargo test` が通る（127件全てパス）

## 作業ログ

### 2026-01-08

**実装完了**

1. **VisualFeedbackConfig 追加** (`src/resource/config.rs`)
   - `VisualFeedbackConfig` struct を追加
   - `hold_color`, `ball_color_topspin`, `ball_color_neutral`, `ball_color_slice` パラメータ
   - `GameConfig` に `visual_feedback` フィールドを追加

2. **BallSpin コンポーネント追加** (`src/components/mod.rs`)
   - `BallSpin` コンポーネントを追加（スピン値 -1.0〜+1.0）
   - `BallBundle` に `ball_spin` フィールドを追加

3. **視覚フィードバックシステム** (`src/presentation/visual_feedback.rs`)
   - `save_player_original_color_system`: プレイヤーの元の色を保存
   - `player_hold_visual_system`: ホールド中にプレイヤー色をオレンジにブレンド
   - `ball_spin_color_system`: スピン値に応じてボール色を変化
   - `lerp_color`: 色の線形補間ユーティリティ

4. **ショット時のスピン設定** (`src/systems/shot_direction.rs`)
   - `shot_direction_system` で `BallSpin.value` に `shot_attrs.spin` を設定

5. **システム登録** (`src/main.rs`)
   - `ShotButtonState` リソースを初期化
   - `track_shot_button_system`: ボタン押下状態を追跡
   - 視覚フィードバックシステムを Update に登録

6. **テスト修正**
   - `boundary.rs`, `fault_judgment.rs` のテスト用 `test_config()` に `visual_feedback` フィールドを追加
