---
id: "30037"
title: "アウト判定システム追加"
type: "game-dev"
status: "done"
priority: "high"
related_task: null
spec_ids: ["30901"]
blocked_by: ["30036"]
blocks: ["30038"]
branch_name: null
worktree_path: null
plan_file: "~/.claude/plans/structured-purring-narwhal.md"
tags: ["tennis", "out", "judgment"]
parent_task_id: null
created_at: "2026-01-08T16:00:00"
updated_at: "2026-01-08T16:00:00"
completed_at: "2026-01-08T19:00:00"
---

# Task 30037: アウト判定システム追加

## Summary

テニスルールに準拠したアウト判定を実装。
ボールがコート外に落ちたら、最後に打った側の失点となる。

## Related Specifications

- `project/docs/3_ingame/309_referee/30901_point_judgment_spec.md` - ポイント判定

## Progress

### Completed

- `ball_trajectory.rs` の `ball_out_of_bounds_system` 強化
  - コート境界外かつ地面着地（Y <= 0）のみアウト判定に変更
  - 仕様書参照コメント追加（@spec 30901_point_judgment_spec.md#req-30901-001）
- `point_judgment.rs` の `out_of_bounds_judgment_system` を主要判定に昇格
  - LastShooter ベースの判定に変更（打った側の失点）
  - コメント更新（安全弁→主要失点条件）
- アウト判定テスト追加（TST-30037-001〜004）
  - サイドライン外アウト
  - ベースライン外アウト
  - コート内着地は失点にならない
  - コーナー外アウト
- ビルド成功、テスト全PASS（135件）

## Next Actions

（完了）

## Dependencies

- **Blocked By:** 30036（壁システム削除が先）
- **Blocks:** 30038（コートサイズ調整）

## Detailed Implementation Plan

### アウト判定ロジック

```
条件: ボールがコート境界外に着地
  - X軸: |x| > court.width / 2（サイドライン外）
  - Z軸: |z| > court.depth / 2（ベースライン外）

結果: 最後に打った側（LastShooter）の失点
```

### 修正対象ファイル

| ファイル | 変更内容 |
|---------|---------|
| `project/src/systems/ball_trajectory.rs` | `ball_out_of_bounds_system` 強化 |
| `project/src/systems/point_judgment.rs` | アウト判定を主要失点条件に |
| `project/src/resource/scoring.rs` | `RallyEndReason::Out` の扱い確認 |
| `project/src/core/events.rs` | `BallOutOfBoundsEvent` 拡張（必要に応じて） |

### 判定フロー

```
1. ボールが地面（Y <= 0）に接触
2. 接触位置がコート境界内か判定
3. 境界外の場合:
   - `BallOutOfBoundsEvent` を発行
   - `LastShooter` から失点側を決定
   - `RallyEndEvent` を発行（reason: Out）
```

### テストケース

- サイドライン外アウト
- ベースライン外アウト
- コーナー付近の境界判定
- コート内着地は失点にならない

## 完了チェックリスト

> このタスクは in-review 経由必須

- [x] ビルド成功（`cargo build`）
- [x] テスト全PASS（`cargo test`）- 135件
- [x] in-review に移動済み
- [x] レビュー完了

## メモ

- パデルでは安全弁だった `Out` 判定が、テニスでは主要失点条件になる
- コート境界値は `game_config.ron` から取得（ハードコーディング禁止）
- `LastShooter` コンポーネントが正しく更新されていることが前提
