---
id: "P003"
title: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°"
type: "project-wide"
status: "done"
priority: "medium"
created_at: "2026-01-08"
updated_at: "2026-01-08"
completed_at: "2026-01-08"
tags: ["architecture", "input", "refactor", "scalability"]
blocked_by: []
blocks: []
---

# P003: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

## æ¦‚è¦

ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ `player1_`/`player2_` ã¨ã„ã†ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒè”“å»¶ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚‹ï¼š
- ãƒ€ãƒ–ãƒ«ã‚¹ï¼ˆ4äººï¼‰ã«å¯¾å¿œä¸å¯
- å…¨å“¡AI / å…¨å“¡äººé–“ã®åˆ‡ã‚Šæ›¿ãˆä¸å¯
- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã®å‹•çš„å¤‰æ›´ä¸å¯
- å…¥åŠ›ãƒ‡ãƒã‚¤ã‚¹ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç´ä»˜ã‘ãŒå›ºå®š

## å®Œäº†ã—ãŸä½œæ¥­

### ãƒ•ã‚§ãƒ¼ã‚º1: å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° âœ…

1. [x] `InputState` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ
2. [x] `HumanControlled` / `AiControlled` ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
3. [x] `human_input_system` å®Ÿè£…
4. [x] `ShotButtonState`, `JumpInput`, `ShotInput`, `MovementInput` ã‚’ `InputState` ã«çµ±åˆ
5. [x] æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã‚’ `InputState` ä½¿ç”¨ã«ç§»è¡Œ
6. [x] AIå…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºç¢ºèªï¼ˆæ—¢å­˜ã® ai_shot_system ã¯åˆ¥çµŒè·¯ã§å‹•ä½œï¼‰
7. [x] æ—§ãƒªã‚½ãƒ¼ã‚¹ãƒ»æ—§é–¢æ•°ã‚’å®Œå…¨ã«å‰Šé™¤
8. [x] CLAUDE.md ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«è¿½åŠ 
9. [x] 20006_input_system.md ä»•æ§˜æ›¸æ›´æ–°

### ãƒ•ã‚§ãƒ¼ã‚º2: ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° ğŸ“‹ åˆ¥ã‚¿ã‚¹ã‚¯åŒ–

ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¯å½±éŸ¿ç¯„å›²ãŒå¤§ãã„ãŸã‚ã€åˆ¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦åˆ‡ã‚Šå‡ºã™ï¼š
- `MatchScore` ã® `player1_score`/`player2_score` ã‚’ CourtSide ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´
- ç¾æ™‚ç‚¹ã§ã¯æ—¢å­˜ã®ã¾ã¾ï¼ˆæ©Ÿèƒ½çš„ã«å•é¡Œãªã—ï¼‰

## å®Ÿè£…è©³ç´°

### æ–°è¦è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«
- `src/systems/human_input.rs` - äººé–“å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ 

### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«
- `src/components/mod.rs` - InputState, HumanControlled è¿½åŠ ã€PlayerBundle ã« InputState è¿½åŠ 
- `src/systems/mod.rs` - human_input ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ ã€æ—§ãƒªã‚½ãƒ¼ã‚¹ã® export å‰Šé™¤
- `src/systems/movement.rs` - InputState ä½¿ç”¨ã«å¤‰æ›´ã€æ—§ãƒªã‚½ãƒ¼ã‚¹ `MovementInput` å‰Šé™¤
- `src/systems/jump.rs` - InputState ä½¿ç”¨ã«å¤‰æ›´ã€æ—§ãƒªã‚½ãƒ¼ã‚¹ `JumpInput` å‰Šé™¤
- `src/systems/shot_input.rs` - InputState ä½¿ç”¨ã«å¤‰æ›´ã€æ—§ãƒªã‚½ãƒ¼ã‚¹ `ShotInput` å‰Šé™¤
- `src/systems/shot_attributes.rs` - `build_shot_context_from_input_state` è¿½åŠ ã€æ—§ã‚³ãƒ¼ãƒ‰å‰Šé™¤
- `src/systems/shot_direction.rs` - InputState å¯¾å¿œã«å¤‰æ›´
- `src/systems/serve.rs` - InputState å¯¾å¿œã«å¤‰æ›´
- `src/presentation/visual_feedback.rs` - InputState ä½¿ç”¨ã«å¤‰æ›´
- `src/main.rs` - HumanControlled è¿½åŠ ã€human_input_system ç™»éŒ²ã€æ—§ãƒªã‚½ãƒ¼ã‚¹åˆæœŸåŒ–å‰Šé™¤

### ä»•æ§˜æ›¸æ›´æ–°
- `.claude/CLAUDE.md` - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å›ºå®šå‚ç…§ç¦æ­¢åŸå‰‡ï¼ˆãƒ«ãƒ¼ãƒ«4ï¼‰ã‚’è¿½åŠ 
- `project/docs/2_architecture/20006_input_system.md` - v4.0.0 ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ™ãƒ¼ã‚¹å…¥åŠ›ç®¡ç†ã«æ›´æ–°

## è¨­è¨ˆæ–¹é‡

### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ã®å…¥åŠ›çŠ¶æ…‹

```rust
// å…¥åŠ›çŠ¶æ…‹ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦ä¿æŒ
#[derive(Component, Default)]
pub struct InputState {
    pub movement: Vec2,
    pub jump_pressed: bool,
    pub shot_pressed: bool,
    pub holding: bool,
    pub hold_time: f32,
}
```

### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç¨®åˆ¥ã®ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```rust
// äººé–“æ“ä½œ
#[derive(Component)]
pub struct HumanControlled {
    pub device_id: usize,  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰=0, ã‚²ãƒ¼ãƒ ãƒ‘ãƒƒãƒ‰=1,2,...
}

// AIæ“ä½œï¼ˆæ—¢å­˜ï¼‰
#[derive(Component)]
pub struct AiController { ... }
```

### å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ ã®åˆ†é›¢

```rust
// äººé–“å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ : HumanControlled ã‚’æŒã¤ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã® InputState ã‚’æ›´æ–°
fn human_input_system(
    keyboard: Res<ButtonInput<KeyCode>>,
    mut query: Query<(&HumanControlled, &mut InputState)>,
) { ... }

// AI ã¯æ—¢å­˜ã® ai_shot_system / ai_movement_system ã§å‹•ä½œ
// InputState ã‚’ä½¿ã‚ãªã„ç‹¬è‡ªçµŒè·¯
```

## å—ã‘å…¥ã‚Œæ¡ä»¶

- [x] å…¥åŠ›ç³»ã® `player1_`/`player2_` ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒå…¨ã¦é™¤å»ã•ã‚Œã¦ã„ã‚‹
- [x] 1P vs AI ãŒæ­£å¸¸å‹•ä½œã™ã‚‹
- [x] CLAUDE.md ã«ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [x] é–¢é€£ä»•æ§˜æ›¸ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆåˆ¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ç¶™ç¶šï¼‰

## ä»Šå¾Œã®èª²é¡Œ

1. **ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°** - åˆ¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦ P004 or R30xxx ã§ç™»éŒ²
2. **ã‚²ãƒ¼ãƒ ãƒ‘ãƒƒãƒ‰å¯¾å¿œ** - HumanControlled.device_id ã‚’æ´»ç”¨
3. **å…¨å“¡AIãƒ¢ãƒ¼ãƒ‰** - HumanControlled ã‚’å¤–ã™ã ã‘ã§å¯¾å¿œå¯èƒ½ãªè¨­è¨ˆ
4. **ãƒ€ãƒ–ãƒ«ã‚¹å¯¾å¿œ** - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¿½åŠ ã§å¯¾å¿œå¯èƒ½ãªè¨­è¨ˆ
