---
id: P003-003
title: 壁・AIパラメータの外部化
type: project-wide
status: done
parent: P003
priority: medium
created: 2026-01-08
blocked_by: [P003-001]
---

# P003-003: 壁・AIパラメータの外部化

## 概要

ハードコーディングされている壁反射・AI関連のパラメータを `game_config.ron` で設定可能にする。

## 対象箇所（3箇所）

| パラメータ | 値 | 用途 | ファイル | 行 |
|-----------|-----|------|---------|-----|
| 壁反射係数 | 0.8 | 壁バウンド減衰 | `wall.rs` | 195, 209, 223, 237, 268, 313, 326, 338 |
| AI停止距離 | 0.3 | ホーム復帰時 | `ai_movement.rs` | 78 |
| コート深さ | 6.0 | AI計算用 | `ai_shot.rs` | 138 |

## 作業内容

1. `BallConfig` に `wall_bounce_factor` を追加
2. `AiConfig` に `home_return_stop_distance` を追加
3. `ai_shot.rs` を `config.court.depth` 参照に修正
4. `game_config.ron` に設定を追加

## 設計

### BallConfig 拡張

```rust
pub struct BallConfig {
    // 既存フィールド...
    pub wall_bounce_factor: f32,  // 新規: 0.8
}
```

### AiConfig 拡張

```rust
pub struct AiConfig {
    // 既存フィールド...
    pub home_return_stop_distance: f32,  // 新規: 0.3
}
```

## 修正対象ファイル

- `project/src/resource/config.rs`
- `project/assets/config/game_config.ron`
- `project/src/core/wall.rs`（8箇所の一括置換）
- `project/src/systems/ai_movement.rs`
- `project/src/systems/ai_shot.rs`

## 検証方法

1. `cargo build` - コンパイル確認
2. `cargo test` - 既存テスト通過
3. ゲーム起動・動作確認
4. `game_config.ron` の値変更 → ホットリロード確認

## 備考

- 壁反射係数は wall.rs 内の8箇所すべてを一括置換
- ai_shot.rs のコート深さは既存の `config.court.depth` を参照するよう修正

## 実施内容

### 修正ファイル

1. **config.rs**
   - `BallConfig` に `wall_bounce_factor: f32` を追加（デフォルト: 0.8）
   - `AiConfig` に `home_return_stop_distance: f32` を追加（デフォルト: 0.3）

2. **game_config.ron**
   - `ball` セクションに `wall_bounce_factor: 0.8` を追加
   - `ai` セクションに `home_return_stop_distance: 0.3` を追加

3. **ball_trajectory.rs**
   - 壁反射処理で `config.ball.bounce_factor` → `config.ball.wall_bounce_factor` に変更

4. **ai_movement.rs**
   - ホーム復帰時の停止距離 `0.3` → `config.ai.home_return_stop_distance` に変更

5. **boundary.rs, fault_judgment.rs**
   - テストコード内の `BallConfig` 初期化に `wall_bounce_factor` フィールドを追加

### 未修正項目

- **wall.rs のテストコード**: テスト用の固定値 `0.8` はそのまま（テストの明示性のため）
- **ai_shot.rs**: 既に `config.court.depth` を使用していたため修正不要
- **ball_trajectory.rs のテストコード**: テスト用の固定値はそのまま

### 検証結果

- `cargo build`: 成功
- `cargo test`: 129テスト全パス
