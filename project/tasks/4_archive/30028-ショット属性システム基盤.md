---
id: "30028"
title: "ショット属性システム基盤"
type: "game-dev"
status: "done"
priority: "high"
related_task: null
spec_ids: ["REQ-30604-050", "REQ-30604-051", "REQ-30604-052", "REQ-30604-053", "REQ-30604-054", "REQ-30604-055", "REQ-30604-056", "REQ-30604-057", "REQ-30604-058", "REQ-30604-059", "REQ-30604-060", "REQ-30604-061", "REQ-30604-062", "REQ-30604-063", "REQ-30604-064", "REQ-30604-065", "REQ-30604-066", "REQ-30604-067"]
blocked_by: []
blocks: ["30029"]
branch_name: "auto-89720-30028-shot-attributes"
worktree_path: "../isdf_padel-30028-shot-attributes"
plan_file: null
tags: ["shot", "attributes", "v0.2", "phase1"]
parent_task_id: null
created_at: "2026-01-07T22:00:00+09:00"
updated_at: "2026-01-08T00:15:00+09:00"
completed_at: "2026-01-08T00:15:00+09:00"
---

# Task 30028: ショット属性システム基盤

## Summary

v0.2のショット属性システムの基盤を実装する。5つの入力要素（入力方式、打点高さ、バウンド経過時間、入り方、距離）から、5つの出力属性（威力、安定性、角度、スピン、精度）を計算するシステム。

## Related Specifications

- [30604_shot_attributes_spec.md](../../docs/3_ingame/306_shot_system/30604_shot_attributes_spec.md)
- [30010_v02_scope.md](../../docs/3_ingame/30010_v02_scope.md)

## Scope

### Phase 1: ショット属性システム基盤

#### 1. コンポーネント設計

- [x] `ShotContext`: 5要素の入力値を保持
  - input_mode: プッシュ/ホールド判定
  - hit_height: 打点の高さ（Y座標）
  - bounce_elapsed: バウンド経過時間
  - approach_dot: 移動ベクトル内積
  - ball_distance: ボールとの距離
- [x] `ShotAttributes`: 計算された属性値を保持
  - power: 威力
  - stability: 安定性
  - angle: 角度
  - spin: スピン
  - accuracy: 精度

#### 2. 入力方式判定（REQ-30604-050〜053）

- [x] プッシュ判定: ボタン押下時にボールがヒット範囲内
- [x] ホールド判定: ボタン押し続けでボールがヒット範囲に入る
- [x] ホールド時間による安定性変化
- [x] プッシュ精度による威力変化

#### 3. 5要素の取得システム（REQ-30604-054〜062）

- [x] 打点高さ取得（Y座標）
- [x] 打点高さによる属性変化（係数テーブル）
- [x] バウンド経過時間取得
- [x] ノーバウンド（ボレー）の属性
- [x] バウンド後のタイミング属性
- [x] 移動ベクトル取得・内積計算
- [x] 入り方による属性変化
- [x] ボール距離取得
- [x] 距離による属性変化

#### 4. 属性計算システム（REQ-30604-063〜067）

- [x] 威力の最終計算（係数の乗算）
- [x] 安定性の最終計算
- [x] 角度の最終計算
- [x] スピンの計算
- [x] 精度の最終計算

## Technical Notes

### データ構造

```rust
// Components
pub struct ShotContext {
    pub input_mode: InputMode,
    pub push_timing_diff: f32,    // ms
    pub hold_duration: f32,        // ms
    pub hit_height: f32,           // m
    pub bounce_elapsed: Option<f32>, // s (None = volley)
    pub approach_dot: f32,         // -1.0 ~ 1.0
    pub ball_distance: f32,        // m
}

pub struct ShotAttributes {
    pub power: f32,      // m/s
    pub stability: f32,  // 0.0 ~ 2.0
    pub angle: f32,      // degrees
    pub spin: f32,       // -1.0 ~ 1.0
    pub accuracy: f32,   // 0.0 ~ 2.0
}

pub enum InputMode {
    Push,
    Hold,
}
```

### 係数カーブ

全てのカーブは `GameConfig` で外部データ化：
- `config.shot_attributes.height_curve`
- `config.shot_attributes.timing_curve`
- `config.shot_attributes.approach_curve`
- `config.shot_attributes.distance_curve`
- `config.shot_attributes.spin_height_curve`
- `config.shot_attributes.spin_timing_curve`

## Progress

### Completed

- [x] コンポーネント設計・実装 (`components/mod.rs`)
- [x] 入力方式判定システム (`systems/shot_attributes.rs`)
- [x] 5要素取得システム (`systems/shot_attributes.rs`)
- [x] 属性計算システム (`systems/shot_attributes.rs`)
- [x] GameConfig へのパラメータ追加 (`resource/config.rs`)
- [x] 単体テスト (7テスト)

## Dependencies

- **Blocked By:** なし
- **Blocks:** 30029（ショット属性の軌道反映）

## Acceptance Criteria

- [x] 5要素から属性が正しく計算される
- [x] 全パラメータが GameConfig で外部データ化されている
- [x] 係数カーブが線形補間で動作する
- [x] ビルド成功（`cargo build`）
- [x] テスト全PASS（`cargo test` - 112テスト）

## Implementation Summary

### 追加ファイル
- `src/systems/shot_attributes.rs`: 属性計算システム

### 変更ファイル
- `src/components/mod.rs`: InputMode, ShotContext, ShotAttributes, BounceState 追加
- `src/resource/config.rs`: ShotAttributesConfig, カーブポイント構造体追加
- `src/systems/mod.rs`: shot_attributes モジュール追加
- `src/systems/boundary.rs`: テスト修正
- `src/systems/fault_judgment.rs`: テスト修正
