---
id: "30029"
title: "ショット属性の軌道反映"
type: "game-dev"
status: "done"
priority: "high"
related_task: null
spec_ids: ["REQ-30604-068", "REQ-30604-069", "REQ-30604-070"]
blocked_by: ["30028"]
blocks: []
branch_name: null
worktree_path: null
plan_file: null
tags: ["shot", "attributes", "trajectory", "v0.2", "phase2"]
parent_task_id: null
created_at: "2026-01-07T22:00:00+09:00"
updated_at: "2026-01-08T16:00:00+09:00"
completed_at: "2026-01-08T16:00:00+09:00"
---

# Task 30029: ショット属性の軌道反映

## Summary

30028で計算されたショット属性（威力、安定性、角度、スピン、精度）をボール軌道に反映する。v0.2 Phase 2の実装。

## Related Specifications

- [30604_shot_attributes_spec.md](../../docs/3_ingame/306_shot_system/30604_shot_attributes_spec.md)
- [30010_v02_scope.md](../../docs/3_ingame/30010_v02_scope.md)

## Scope

### Phase 2: ショット実行への反映

#### 1. 威力のボール速度反映（REQ-30604-068）

- [x] 威力（power）→ ボール初速度への変換
- [x] 既存の `shot_direction_system` との統合

#### 2. 安定性によるミスショット判定（REQ-30604-069）

- [x] 安定性閾値のチェック
- [x] 確率的ミスショット発生
- [x] ミスショット時の挙動（角度・方向のランダムブレ）

#### 3. 精度によるコースブレ（REQ-30604-070）

- [x] 精度に応じた方向誤差計算
- [x] 最大方向ブレの適用

#### 4. 角度・スピンの反映

- [x] 発射角度への反映
- [x] スピン値は計算済み（将来の軌道カーブ用に保持）

## Implementation Notes

### 変更ファイル

- `project/Cargo.toml`: `rand` クレート追加
- `project/src/systems/shot_direction.rs`: ショット属性の軌道反映実装
- `project/src/systems/ai_movement.rs`: Bevy 0.17 API対応修正

### システム統合

`shot_direction_system` を拡張して以下を実装:

1. **ShotContext 構築**: プレイヤー情報、ボール情報から5要素を取得
2. **属性計算**: `calculate_shot_attributes()` を呼び出し
3. **威力反映**: `power` をボール初速度として使用
4. **角度反映**: `angle` を発射角度として使用
5. **ミスショット判定**: `stability` が閾値未満なら確率的にミス
6. **コースブレ**: `accuracy` に応じた方向誤差を追加

### 新規関数

```rust
/// ミスショット判定
fn check_miss_shot(stability: f32, config: &ShotAttributesConfig) -> (bool, f32)

/// 精度によるコースブレ計算
fn calculate_direction_error(accuracy: f32, config: &ShotAttributesConfig) -> f32

/// 方向にオフセットを適用（XZ平面回転）
fn apply_direction_offset(horizontal_dir: Vec3, offset_deg: f32) -> Vec3
```

## Progress

### Completed

- [x] 威力→初速度の反映
- [x] 角度→発射角度の反映
- [x] 安定性→ミスショット判定
- [x] 精度→コースブレ
- [x] スピン値計算・保持
- [x] ユニットテスト追加（5件）
- [x] ビルド成功
- [x] テスト全PASS（119件）

## Dependencies

- **Blocked By:** 30028（ショット属性システム基盤）✅ 完了
- **Blocks:** なし（AI強化タスクが後続予定）

## Acceptance Criteria

- [x] 威力が高いショットは速い
- [x] 安定性が低いとミスショットが発生する
- [x] 精度が低いとコースがブレる
- [x] 高い打点からはトップスピン傾向（spin値で表現）
- [x] 低い打点からはスライス傾向（spin値で表現）
- [x] ビルド成功（`cargo build`）
- [x] テスト全PASS（`cargo test`）

## Test Coverage

- `test_check_miss_shot_stable`: 高い安定性ではミスショット発生しない
- `test_apply_direction_offset_zero`: オフセットなしで方向維持
- `test_apply_direction_offset_90_degrees`: 90度回転テスト
- `test_apply_direction_offset_minus_45_degrees`: -45度回転テスト
- `test_calculate_direction_error_perfect_accuracy`: 完璧な精度でブレなし
