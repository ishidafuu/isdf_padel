---
id: "30040"
title: "座標系変更（論理座標を画面表示と一致させる）"
status: "done"
priority: "high"
created: "2025-01-08"
updated_at: "2025-01-08"
refs:
  - plan: "~/.claude/plans/lazy-puzzling-blum.md"
---

# 30040: 座標系変更

## 概要

論理座標系を画面表示と一致させ、コードの直感性を向上させる。

### 旧座標系（変更前）
- X = コート幅移動（画面の上下に表示）
- Y = ジャンプ高さ
- Z = 打ち合い方向（画面の左右に表示）
- 表示時に90度回転変換が必要

### 新座標系（変更後）
- **X = 打ち合い方向（左右）** ← 画面Xと一致
- **Y = ジャンプ高さ**
- **Z = コート幅移動（奥行き）** ← 画面Yに合成

## 変更対象

### 設定構造体
- `src/resource/config.rs`: フィールド名変更（net_z→net_x等）
- `assets/config/game_config.ron`: 対応変更

### コア構造体
- `src/core/court.rs`: CourtBounds, NetInfo, determine_court_side
- `src/core/wall.rs`: 壁反射座標
- `src/core/events.rs`: WallType法線

### ファクトリ
- `src/systems/court_factory.rs`: create_court_bounds, create_net_info

### 表示層
- `src/presentation/mod.rs`: sync_transform_system, sync_shadow_system
- `src/main.rs`: spawn_court, プレイヤー初期位置

### ゲームロジック層
- `src/systems/movement.rs`: 境界制限
- `src/systems/boundary.rs`: プレイヤー境界制限
- `src/systems/ball_trajectory.rs`: ボール位置判定
- `src/systems/shot_direction.rs`: ショット方向
- `src/systems/ai_movement.rs`: AI位置判定
- `src/systems/serve.rs`: サーブ方向
- `src/systems/point_judgment.rs`: ネット判定
- `src/systems/fault_judgment.rs`: サービスボックス判定
- `src/systems/knockback.rs`: 境界取得
- `src/systems/match_flow.rs`: 初期位置

## Acceptance Criteria

- [x] cargo build 成功
- [x] cargo test 成功（135件全て合格）
- [x] プレイヤーが正しい位置に表示される
- [x] W/Sで画面上下（コート幅方向）に移動
- [x] A/Dで画面左右（打ち合い方向、自コート内）に移動
- [x] ボールが正しく打ち合いされる
- [x] AIが正しく動作する

## 完了サマリー

18ファイルを変更し、座標系を画面表示と一致させた：
- 設定層: config.rs, game_config.ron
- コア層: court.rs, wall.rs, events.rs
- 表示層: presentation/mod.rs, main.rs
- ゲームロジック層: 10ファイル

主な変更点：
- `net_z` → `net_x`
- `z_min/z_max` → `x_min/x_max`
- `direction_z` → `direction_x`
- `home_position_z` 削除（`home_position_x`に統合）
- 90度回転変換 → 直接マッピング
