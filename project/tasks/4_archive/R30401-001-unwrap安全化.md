---
id: "R30401-001"
title: "ball_trajectory.rsのunwrap安全化"
type: "refactor"
status: "done"
priority: "medium"
related_task: "30007"
spec_ids: ["30401"]
blocked_by: []
blocks: []
branch_name: null
worktree_path: null
plan_file: null
tags: ["systems", "safety", "unwrap", "audit"]
parent_task_id: null
created_at: "2026-01-08T00:00:00"
updated_at: "2026-01-09T00:00:00"
completed_at: "2026-01-09T00:00:00"
---

# Task R30401-001: ball_trajectory.rsのunwrap安全化

## Summary

audit-agent による監査で検出された問題。
`ball_trajectory.rs` 内で `unwrap()` が3箇所使用されている。
テストコード内の使用は除外。

## 検出箇所（調査結果）

| ファイル | 行 | コード | 場所 | 対応 |
|---------|---|--------|------|------|
| ball_trajectory.rs | 411, 444, 478 | `result.unwrap()` | **テスト** | 除外 |
| ball_collision.rs | 127 | `closest.unwrap().2` | **本体** | ✅ 修正済 |
| boundary.rs | 276 | `result.unwrap()` | **テスト** | 除外 |

**結果**: ball_trajectory.rs の3箇所は全てテストコード内。本体コードで唯一の問題は `ball_collision.rs:127` のみ。

## Related Specifications

- [30401_trajectory_spec.md](../../docs/3_ingame/304_ball/30401_trajectory_spec.md)

## 修正内容

### ball_collision.rs:127
```rust
// Before
if closest.is_none() || distance_2d < closest.unwrap().2 {

// After
if closest.as_ref().map_or(true, |(_, _, d)| distance_2d < *d) {
```

`map_or` パターンを使用し、Option の安全なアクセスに変更。

## 完了チェックリスト

> このタスクは in-review 経由必須

- [x] ビルド成功（`cargo build`）
- [x] テスト全PASS（`cargo test`）- 135件
- [x] in-review に移動済み
- [x] レビュー完了

## メモ

- ball_trajectory.rs の unwrap は全てテストコード内（タスク除外対象）
- boundary.rs の unwrap もテストコード内（タスク除外対象）
- 本体コードでの unwrap は ball_collision.rs の1箇所のみ → 修正完了
