---
id: "30044"
title: "オーバーハンドサーブ・AI自動サーブ"
type: "game-dev"
status: "done"
priority: "high"
related_task: null
spec_ids: ["30102"]
blocked_by: []
blocks: []
branch_name: "task/30044_overhand_serve_ai"
worktree_path: ".worktrees/30044"
plan_file: null
tags: ["v0.4", "serve", "ai"]
parent_task_id: null
created_at: "2026-01-09T12:00:00"
updated_at: "2026-01-09T13:00:00"
completed_at: "2026-01-09T13:00:00"
---

# Task 30044: オーバーハンドサーブ・AI自動サーブ

## Summary

v0.4のサーブ機能拡張。テニス式オーバーハンドサーブと、AIプレイヤーの自動サーブを実装する。

## Related Specifications

- `project/docs/3_ingame/301_match/30102_serve_spec.md` - サーブ仕様
- `project/docs/8_data/80101_game_constants.md` - ゲーム定数

## Implementation Plan

### 実装する機能

| 機能 | REQ-ID | 説明 |
|------|--------|------|
| オーバーハンドサーブ | REQ-30102-060 | 高い打点からの発射 |
| AI自動サーブ | REQ-30102-070 | 一定時間後に自動サーブ |
| AIサーブ方向ランダム | REQ-30102-071 | Z方向にランダムバリエーション |

### Step 1: パラメータ追加 ✅ 完了

- [x] `config.rs`: ServeConfig に serve_speed, serve_angle 追加
- [x] `config.rs`: AiConfig に serve_delay_min/max, serve_direction_variance 追加
- [x] `game_config.ron`: 新フィールド追加
- [x] `80101_game_constants.md`: データ定義更新
- [x] `30102_serve_spec.md`: 仕様書 v2.0.0 更新

### Step 2: オーバーハンドサーブ弾道計算 ✅ 完了

- [x] `serve.rs`: serve_speed, serve_angle を使用した弾道計算に変更

### Step 3: AI自動サーブシステム ✅ 完了

- [x] `ai_serve.rs`: 新規作成
  - AiServeTimer リソース（タイマー管理）
  - ai_serve_timer_init_system（タイマー初期化）
  - ai_serve_execute_system（サーブ実行）
  - AiServePlugin（プラグイン）
- [x] `systems/mod.rs`: ai_serve モジュール追加
- [x] `main.rs`: AiServePlugin を登録

### Step 4: テスト・確認 ✅ 完了

- [x] ビルド通過（警告なし）
- [x] 全145テスト通過

## Modified Files

| ファイル | 変更内容 |
|---------|---------|
| `project/src/resource/config.rs` | ServeConfig, AiConfig 拡張、dead_code警告抑制 ✅ |
| `project/assets/config/game_config.ron` | パラメータ追加 ✅ |
| `project/docs/3_ingame/301_match/30102_serve_spec.md` | v2.0.0 更新 ✅ |
| `project/docs/8_data/80101_game_constants.md` | v3.2.0 更新 ✅ |
| `project/src/systems/serve.rs` | オーバーハンドサーブ弾道計算 ✅ |
| `project/src/systems/ai_serve.rs` | **新規**: AI自動サーブ ✅ |
| `project/src/systems/mod.rs` | ai_serve追加 ✅ |
| `project/src/main.rs` | AiServePlugin登録 ✅ |

## Acceptance Criteria

- [x] オーバーハンドサーブが serve_speed, serve_angle で発射される
- [x] AIがサーブ権を持つ時、0.5〜1.5秒後に自動サーブ
- [x] AIのサーブ方向がZ方向 ±0.5 でランダム化
- [x] ビルド・テスト通過

## Dependencies

- **Blocked By:** なし
- **Blocks:** なし

## Notes

- AiServeTimerはリソースで管理（サーブは1人のみなのでECS原則に反しない）
- normal_shot_speed, normal_shot_angleにdead_code警告抑制追加（v0.4着地点逆算型弾道で使用予定）
