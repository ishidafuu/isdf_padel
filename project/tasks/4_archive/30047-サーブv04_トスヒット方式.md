---
id: "30047"
title: "サーブv0.4 トス→ヒット方式"
type: "game-dev"
status: "done"
priority: "high"
related_task: null
spec_ids: ["30102"]
blocked_by: []
blocks: []
branch_name: "task/30047_serve_toss_hit"
worktree_path: ".worktrees/30047"
plan_file: null
tags: ["v0.4", "serve", "toss"]
parent_task_id: null
created_at: "2026-01-09T15:00:00"
updated_at: "2026-01-09T15:00:00"
completed_at: null
---

# Task 30047: サーブv0.4 トス→ヒット方式

## Summary

現在の「ボタン押下→即発射」を「トス→ヒット」の2段階方式に改修する。併せて、サーブ打つまではベースライン上のみ移動可能にする。

## Related Specifications

- `project/docs/3_ingame/301_match/30102_serve_spec.md` - サーブ仕様
- `project/docs/8_data/80101_game_constants.md` - ゲーム定数
- `project/docs/3_ingame/302_player/30201_movement_spec.md` - 移動システム仕様

## Implementation Plan

### 実装する機能

| 機能 | REQ-ID | 説明 |
|------|--------|------|
| トス開始 | REQ-30102-080 | 1回目ボタンでトス |
| トス物理 | REQ-30102-081 | 上昇→落下 |
| ヒット入力 | REQ-30102-082 | 2回目ボタンでヒット |
| ヒット可能範囲 | REQ-30102-083 | 高さ1.8m〜2.7m |
| トスタイムアウト | REQ-30102-084 | 3秒でFault |
| トス中移動禁止 | REQ-30102-085 | 完全静止 |
| ベースライン制限 | REQ-30102-086 | サーブ前X座標固定 |
| AIトス | REQ-30102-087 | AI用トス実行 |
| AIヒット | REQ-30102-088 | AI用ヒット実行 |
| ダブルフォルト | REQ-30102-089 | 2回ミスで失点 |

### Phase 1: 仕様書更新

- [ ] `30102_serve_spec.md`: REQ-30102-080〜089追加
- [ ] `80101_game_constants.md`: ServeConfigパラメータ追加

**追加パラメータ**:
```rust
// トス関連
pub toss_start_offset_y: f32,    // 1.0m（手元高さ）
pub toss_velocity_y: f32,        // 3.5 m/s（上向き初速）
pub toss_timeout: f32,           // 3.0秒

// ヒット関連
pub hit_height_min: f32,         // 1.8m
pub hit_height_max: f32,         // 2.7m
pub hit_height_optimal: f32,     // 2.2m

// ベースライン
pub serve_baseline_x_p1: f32,    // -7.0m
pub serve_baseline_x_p2: f32,    // +7.0m
```

### Phase 2: 基盤実装

- [ ] `scoring.rs`: ServeSubPhase, ServeState追加
  ```rust
  pub enum ServeSubPhase { Waiting, Tossing, Hitting }
  pub struct ServeState {
      pub phase: ServeSubPhase,
      pub toss_time: f32,
      pub toss_origin: Option<Vec3>,
      pub fault_count: u8,
  }
  ```
- [ ] `config.rs`: ServeConfigパラメータ追加
- [ ] `game_config.ron`: 新規パラメータ追加

### Phase 3: サーブシステム改修

- [ ] `serve.rs`: 全面改修
  - `serve_init_system`: ServeState初期化
  - `serve_toss_input_system`: トス開始
  - `serve_toss_physics_system`: 重力適用（TossBallマーカー）
  - `serve_hit_input_system`: ヒット実行
  - `serve_toss_timeout_system`: Fault判定
  - `serve_fault_system`: ダブルフォルト処理

### Phase 4: 移動制限

- [ ] `movement.rs`: サーブ時制限追加
  - ベースライン制限（X座標固定）
  - トス中移動禁止

### Phase 5: AI対応

- [ ] `ai_serve.rs`: トス→ヒット対応
  - `ai_serve_toss_system`: AIトス実行
  - `ai_serve_hit_system`: AIヒット（高さ監視＆実行）

## Modified Files

| ファイル | 変更内容 |
|---------|---------|
| `project/docs/3_ingame/301_match/30102_serve_spec.md` | REQ-30102-080〜089追加 |
| `project/docs/8_data/80101_game_constants.md` | ServeConfigパラメータ追加 |
| `project/src/resource/scoring.rs` | ServeSubPhase, ServeState追加 |
| `project/src/resource/config.rs` | ServeConfigパラメータ追加 |
| `project/src/systems/serve.rs` | トス/ヒットシステムに全面改修 |
| `project/src/systems/ai_serve.rs` | AI用トス→ヒット対応 |
| `project/src/systems/movement.rs` | サーブ時ベースライン制限追加 |
| `project/assets/config/game_config.ron` | 新規パラメータ追加 |

## Acceptance Criteria

- [ ] 1回目ボタンでトス開始、ボールが上昇する
- [ ] ボールが重力で落下する
- [ ] 2回目ボタンでヒット、Rally状態に遷移する
- [ ] ヒット可能高さ外でボタン押下しても発射されない
- [ ] ボール落下（高さ<1.8m）でFault
- [ ] 3秒経過でFault
- [ ] 1回目FaultでセカンドサーブになりServe状態継続
- [ ] 2回目Faultで相手に1ポイント
- [ ] サーブ前はX方向に移動不可、Z方向のみ可能
- [ ] トス中は完全に移動不可
- [ ] AIがトス→ヒットを自動実行する
- [ ] 全テストが通過する

## Dependencies

- **Blocked By:** なし
- **Blocks:** なし

## Notes

- トスボールは `TossBall` マーカーで区別、ヒット成功時に通常Ballに変換
- トス物理は既存の重力システム（-4.0 m/s^2）を使用
- fault_countは各ポイント開始時に0にリセット
- ベースライン位置は1P: X=-7.0m, 2P: X=+7.0m（ネットから7m）
