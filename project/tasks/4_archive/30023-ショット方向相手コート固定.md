---
id: "30023"
title: "ショット方向相手コート固定"
type: game-dev
status: done
priority: high
created: 2025-01-07
completed: 2025-01-07
spec_refs:
  - "project/docs/3_ingame/306_shot_system/30602_shot_direction_spec.md"
impl_refs:
  - "project/src/systems/shot_input.rs"
  - "project/src/systems/shot_direction.rs"
  - "project/src/core/events.rs"
  - "project/src/systems/serve.rs"
---

# 30023: ショット方向相手コート固定

## 概要

ショットの打球方向が常に相手コートに向かうように修正する。現在の実装では移動入力（十字キー）がそのままショット方向に反映されるため、上下に移動しながらショットすると相手コート以外の方向にボールが飛んでしまう問題がある。

## 問題の詳細

### 現状の動作

- プレイヤーの移動入力（十字キー）がそのままショット方向に使われている
- 上下移動中にショットすると、ボールが上下方向に飛ぶ
- ゲームとして成り立たない

### 原因

`shot_input.rs` でプレイヤーの移動入力（`MovementInput`）をそのままショット方向として使用している。

## 修正方針

REQ-30602-001（仕様書更新済み）に従い：

1. **Z軸方向（前後）: 常に相手コート方向に固定**
   - Player.court_side に基づいて決定（プレイヤーIDではなく所属コートサイド）
   - Player1側コート: Z正方向（+Z）
   - Player2側コート: Z負方向（-Z）
   - 上下入力は無視する

2. **X軸方向（左右）: 入力で調整可能**
   - 左右入力がある場合: 入力方向に応じて左右に打ち分け
   - 左右入力がない場合: ストレート（X = 0）

## 実装内容

### 1. ShotEvent に court_side を追加（events.rs）

```rust
pub struct ShotEvent {
    pub player_id: u8,
    pub court_side: CourtSide,  // 追加
    pub direction: Vec2,
    pub jump_height: f32,
}
```

### 2. shot_input.rs の修正

- X軸入力のみを使用（上下入力は無視）
- ShotEvent に player.court_side を渡す

```rust
let direction = Vec2::new(raw_direction.x, 0.0);
event_writer.write(ShotEvent {
    player_id: player.id,
    court_side: player.court_side,
    direction,
    jump_height: player_pos.y,
});
```

### 3. shot_direction.rs の修正

`calculate_horizontal_direction` を修正して、CourtSide に応じてZ軸方向を固定：

```rust
fn calculate_horizontal_direction(direction: Vec2, court_side: CourtSide) -> Vec3 {
    let z_direction = match court_side {
        CourtSide::Player1 => 1.0,   // Player1側コート: +Z方向（相手コート）
        CourtSide::Player2 => -1.0,  // Player2側コート: -Z方向（相手コート）
    };
    Vec3::new(direction.x, 0.0, z_direction).normalize()
}
```

### 4. serve.rs の修正

サーブ時も court_side を ShotEvent に渡すように修正。

## 受け入れ条件

- [x] Player1側コートのショットは常にZ正方向（相手コート）に飛ぶ
- [x] Player2側コートのショットは常にZ負方向（相手コート）に飛ぶ
- [x] 上下移動中にショットしてもボールは相手コートに飛ぶ
- [x] 左右入力でショットの左右打ち分けができる
- [x] 既存のテストが通る（105テスト全てパス）

## 設計判断

**プレイヤーIDではなくCourtSideを使用する理由**:
- プレイヤーIDは固定だが、プレイヤーの所属コートサイドは変わりうる
- サーブ権交代やコートチェンジでプレイヤーの位置が変わる可能性
- Player コンポーネントに court_side が既に存在していたため活用

## 関連

- 仕様書: REQ-30602-001（更新済み）
- 元タスク: 30011-打球方向計算
