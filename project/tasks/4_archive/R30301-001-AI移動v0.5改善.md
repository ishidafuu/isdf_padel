# R30301-001: AI移動システム v0.5 改善

## 概要

AIの挙動を改善し、より自然で効果的な動きを実現する。

## 解決する問題

1. **ボールを追いかけすぎる** - 現在位置を直接追跡するため無駄な動きが多い
2. **待機位置が不適切** - 固定ホームポジション（X=7.0m）で、軌道に応じた待ち方をしない
3. **リカバリーがない** - ショット後に隙ができない位置に戻らない

## 実装内容

### 1. 着地点予測移動
- ボールの軌道から着地点を予測し先回り移動
- 放物線運動の二次方程式を解いて着地点を計算

### 2. 動的待機位置
- 相手の返球範囲をカバーする位置で待機
- Z軸: ボール位置に応じて調整

### 3. リカバリーポジショニング
- 打球後に最適位置へ戻る
- 打球方向の逆サイドにやや寄る

## 修正ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/components/mod.rs` | BallPrediction追加、AiController拡張 |
| `src/resource/config.rs` | AiConfigにv0.5パラメータ追加 |
| `src/systems/ai_movement.rs` | target_positionベースの移動に変更 |
| `src/systems/ball_prediction.rs` | 新規: 着地点予測システム |
| `src/systems/mod.rs` | 新システム登録 |
| `assets/config/game_config.ron` | 新パラメータ追加 |
| `docs/3_ingame/303_ai/30301_ai_movement_spec.md` | v0.5仕様追加 |

## 新規コンポーネント

### BallPrediction
```rust
#[derive(Component, Debug, Clone, Default)]
pub struct BallPrediction {
    pub landing_position: Vec3,
    pub time_to_landing: f32,
    pub is_valid: bool,
}
```

### AiMovementState
```rust
#[derive(Debug, Clone, Copy, Default, PartialEq)]
pub enum AiMovementState {
    #[default]
    Idle,       // 待機中
    Tracking,   // 追跡中
    Recovering, // リカバリー中
}
```

## 新規パラメータ（AiConfig）

| パラメータ | デフォルト | 説明 |
|-----------|-----------|------|
| optimal_depth | 5.0m | 待機時のX軸深さ |
| coverage_bias_factor | 0.3 | Z軸調整係数 |
| max_z_offset | 3.0m | Z軸移動の最大値 |
| recovery_depth | 4.0m | リカバリー時のX軸深さ |
| recovery_bias_factor | 0.5 | 打球逆サイドへの寄り係数 |
| max_recovery_z | 2.5m | リカバリーZ軸の最大値 |

## 検証方法

1. `cargo run` でゲームを実行
2. 目視確認:
   - AIがボールの着地点に先回りして移動するか
   - 相手側にボールがある時、中央付近で待機するか
   - ショット後にリカバリー位置に戻るか

## 関連仕様

- `docs/3_ingame/303_ai/30301_ai_movement_spec.md`

## ステータス

- [x] Phase 1: 基盤整備（コンポーネント、設定）
- [x] Phase 2: 着地点予測システム
- [x] Phase 3: AI目標計算システム
- [x] Phase 4: ai_movement_system 統合
- [x] Phase 5: 仕様書更新
