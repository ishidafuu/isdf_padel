---
id: "30043"
title: "着地点逆算型弾道システム"
type: "game-dev"
status: "done"
priority: "high"
related_task: null
spec_ids: ["30605", "30012"]
blocked_by: []
blocks: []
branch_name: "task/30043_trajectory_landing"
worktree_path: ".worktrees/30043"
plan_file: null
tags: ["v0.4", "trajectory", "landing"]
parent_task_id: null
created_at: "2026-01-09T10:00:00"
updated_at: "2026-01-09T12:00:00"
completed_at: "2026-01-09T13:00:00"
---

# Task 30043: 着地点逆算型弾道システム

## Summary

固定角度発射から「着地点逆算型発射」に変更。入力から着地地点を決定し、そこに落ちるよう角度・初速を逆算するシステムを実装する。

## Related Specifications

- `project/docs/3_ingame/306_shot_system/30605_trajectory_calculation_spec.md` - 弾道計算仕様
- `project/docs/3_ingame/30012_v04_scope.md` - v0.4スコープ定義
- `project/docs/3_ingame/306_shot_system/30604_shot_attributes_spec.md` - ショット属性仕様
- `project/docs/8_data/80101_game_constants.md` - ゲーム定数

## Implementation Plan

### 実装する機能

| 機能 | REQ-ID | 説明 |
|------|--------|------|
| 着地地点決定 | REQ-30605-010〜013 | 入力から着地座標を計算 |
| 有効重力計算 | REQ-30605-020 | スピン考慮の重力算出 |
| 弾道逆算 | REQ-30605-021〜024 | 放物線公式で角度逆算 |
| 初速調整 | REQ-30605-030〜033 | 球種・距離による係数 |
| ズレ計算 | REQ-30605-040 | 精度による着地偏差 |

### Step 1: パラメータ追加

- [ ] `config.rs`: TrajectoryConfig構造体追加
- [ ] `game_config.ron`: trajectoryセクション追加
- [ ] `GameConfig`: trajectoryフィールド追加

**追加パラメータ**:
```rust
pub struct TrajectoryConfig {
    pub landing_margin: f32,           // 0.5m
    pub default_landing_depth: f32,    // 4.0m
    pub min_launch_angle: f32,         // 5°
    pub max_launch_angle: f32,         // 60°
    pub spin_speed_flat: f32,          // 1.0
    pub spin_speed_topspin: f32,       // 0.92
    pub spin_speed_slice: f32,         // 0.88
    pub distance_speed_min: f32,       // 1.0
    pub distance_speed_max: f32,       // 1.15
    pub max_landing_deviation: f32,    // 1.0m
}
```

### Step 2: 弾道計算モジュール追加

- [ ] `trajectory_calculator.rs`: 弾道計算ロジック新規作成
  - `calculate_landing_position()`: 入力→着地座標
  - `calculate_effective_gravity()`: スピン→有効重力
  - `calculate_launch_angle()`: 放物線公式で角度逆算
  - `calculate_speed_factors()`: 球種・距離係数
  - `apply_landing_deviation()`: 精度によるズレ

### Step 3: shot_direction.rs修正

- [ ] `shot_direction_system`を着地計算型に変更
  - 既存の固定角度計算を置き換え
  - TrajectoryCalculatorを呼び出し
  - 最終的な発射パラメータを設定

### Step 4: テスト追加

- [ ] 単体テスト追加
  - TST-30605-001〜004: 着地地点テスト
  - TST-30605-010〜012: 弾道逆算テスト
  - TST-30605-020〜022: 初速係数テスト
  - TST-30605-030: ズレ計算テスト

### Step 5: 統合テスト

- [ ] ビルド・テスト通過確認
- [ ] 視覚確認（着地位置が入力通りか）

## Modified Files

| ファイル | 変更内容 |
|---------|---------|
| `project/src/resource/config.rs` | TrajectoryConfig追加 |
| `project/assets/config/game_config.ron` | trajectoryパラメータ追加 |
| `project/src/systems/trajectory_calculator.rs` | **新規**: 弾道計算ロジック |
| `project/src/systems/shot_direction.rs` | 着地計算型に変更 |
| `project/src/systems/mod.rs` | trajectory_calculator追加 |

## Acceptance Criteria

- [ ] TrajectoryConfigが実装され、RONで設定可能
- [ ] 入力なし時、サービスライン付近・中央に着地
- [ ] 前入力でネット際に着地
- [ ] 後入力でベースライン際に着地
- [ ] 左右入力でサイドライン際に着地
- [ ] スピンによる有効重力変動が反映される
- [ ] 球種・距離による初速係数が適用される
- [ ] 精度に応じたズレが発生する
- [ ] 全テストが通過する

## Dependencies

- **Blocked By:** なし（v0.3完了済み）
- **Blocks:** なし

## Notes

- v0.3で実装済みのスピン軌道影響はそのまま使用
- 角度主体の調整（テニス的アプローチ）
- 届かない距離では自動で初速を微調整
- 放物線公式の二次方程式解法を使用（計算コスト低い）

## Progress

### Completed

- [x] Step 1: TrajectoryConfig構造体をconfig.rsに追加（全10パラメータ）
- [x] Step 2: game_config.ronにtrajectoryセクション追加
- [x] Step 3: trajectory_calculator.rs新規作成
  - calculate_landing_position(): 入力→着地座標計算
  - calculate_effective_gravity(): スピン→有効重力算出
  - calculate_launch_angle(): 放物線公式で角度逆算
  - calculate_speed_factors(): 球種・距離係数
  - apply_landing_deviation(): 精度によるズレ
- [x] Step 4: shot_direction.rsを着地計算型に変更
- [x] Step 5: 単体テスト11件追加（全142件通過）
- [x] ビルド・テスト通過確認

### Worktree状態

- ブランチ: `task/30043_trajectory_landing`
- コミット済み: `f38108b feat(30043): 着地点逆算型弾道システム実装`
- mainへのマージ: **未完了（レビュー待ち）**

## Next Actions

1. **コードレビュー実施** - review-agent でレビュー
2. mainにマージ（スカッシュマージ）
3. タスクファイルを3_doneに移動
4. worktree削除

## メモ

- boundary.rs, fault_judgment.rsのテストにもTrajectoryConfig追加が必要だった
- ShotAttributes.angleフィールドは現在未使用（警告あり）→ 将来使用予定として残存
