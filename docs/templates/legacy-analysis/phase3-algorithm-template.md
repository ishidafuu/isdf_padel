# [アルゴリズム名] Algorithm

**解析日**: YYYY-MM-DD
**解析者**: legacy-analyzer-agent
**対象ファイル**: legacy/src/[path]/[ファイル名].cpp
**対象関数/メソッド**: [FunctionName]
**制作者確認**: [ ] 未確認 / [ ] 確認済み

---

## 概要

[このアルゴリズムが何を解決するかを1-2文で説明]

例:
ダメージ計算アルゴリズムは、攻撃側と防御側のパラメータから最終ダメージ値を算出します。

**制作者による補完**:
- （例: 「このアルゴリズムはゲームバランスの要。何度も調整した」）

---

## 位置情報

**参照**: legacy/src/[path]/[ファイル名].cpp:XX-YY

**関数シグネチャ**:
```cpp
ReturnType functionName(ParamType1 param1, ParamType2 param2);
```

**呼び出し箇所**:
- [Class1]::[Method1] (legacy/src/[path1]/[file1].cpp:ZZ)
- [Class2]::[Method2] (legacy/src/[path2]/[file2].cpp:WW)

---

## 完全なコード

**Serena MCPで取得した完全なコード**:
```cpp
// legacy/src/[path]/[ファイル名].cpp:XX-YY
ReturnType functionName(ParamType1 param1, ParamType2 param2) {
    // 完全な実装をここに記載
    // ...

    return result;
}
```

---

## アルゴリズムの説明

### 目的

[このアルゴリズムが解決する問題を詳しく説明]

**制作者による補完**:
- （例: 「単純な引き算だと防御が高すぎると攻撃が無意味になるため、最低ダメージを保証した」）

---

### 入力

| パラメータ | 型 | 説明 | 範囲/制約 |
|-----------|-----|------|---------|
| param1 | Type1 | [説明] | [範囲] |
| param2 | Type2 | [説明] | [範囲] |

**確認事項**:
- [ ] パラメータの意味は何ですか？
- [ ] 想定される入力範囲は？
- [ ] 異常な入力の処理は？

**制作者による補完**:
- （例: 「param1は攻撃力。1〜999の範囲を想定」）
- （例: 「負の値は来ないはずだが、チェックしていない」）

---

### 出力

**戻り値**:
- 型: ReturnType
- 意味: [何を返すか]
- 範囲: [範囲]

**確認事項**:
- [ ] 戻り値の意味は何ですか？
- [ ] 特殊な値（0, -1等）の意味は？

**制作者による補完**:
- （例: 「ダメージ値を返す。0以上の整数」）
- （例: 「-1は計算エラーを示す（実際には使っていない）」）

---

## 処理の流れ

### ステップ by ステップ

#### Step 1: [ステップ名]

**コード**:
```cpp
// 該当部分のコード
Type1 var1 = ...;
```

**説明**:
[このステップが何をするか]

**確認事項**:
- [ ] このステップの意図は？

**制作者による補完**:
- （例: 「基礎ダメージの計算」）

---

#### Step 2: [ステップ名]

**コード**:
```cpp
// 該当部分のコード
if (condition) {
    // ...
}
```

**説明**:
[このステップが何をするか]

**確認事項**:
- [ ] この条件判定の意味は？

**制作者による補完**:
- （例: 「防御力が攻撃力を上回る場合の特別処理」）

---

#### Step 3: [ステップ名]

（同様の形式で記述）

---

### フローチャート

```
Start
  ↓
[Step 1: 基礎計算]
  ↓
条件判定A
  ├─ YES → [Step 2A]
  └─ NO  → [Step 2B]
  ↓
[Step 3: 最終調整]
  ↓
条件判定B
  ├─ YES → [Step 4A]
  └─ NO  → [Step 4B]
  ↓
Return result
```

**確認事項**:
- [ ] このフローは正しいですか？
- [ ] 特殊なケースの処理は？

---

## 数式・計算式

### メインの計算式

**コードから抽出**:
```
baseDamage = attacker.attack - defender.defense

if (baseDamage < 1) {
    baseDamage = 1  // 最低ダメージ保証
}

finalDamage = baseDamage * randomFactor
```

**数学的表記**:
```
D_base = max(A - D, 1)
D_final = D_base × R

ここで、
A: 攻撃力
D: 防御力
R: 乱数係数 (0.8 〜 1.2)
D_final: 最終ダメージ
```

**確認事項**:
- [ ] この式の根拠は？
- [ ] 乱数の範囲を教えてください

**制作者による補完**:
- （例: 「式は試行錯誤で決めた。バランス調整が大変だった」）
- （例: 「乱数は ±20%。もっと幅を広げたかった」）

---

### 補助的な計算式

（必要に応じて追加の数式を記載）

---

## 定数・マジックナンバー

| 定数 | 値 | 意味 | 根拠 |
|------|-----|------|------|
| MIN_DAMAGE | 1 | 最低ダメージ | （推測） |
| RANDOM_MIN | 0.8 | 乱数最小値 | （推測） |
| RANDOM_MAX | 1.2 | 乱数最大値 | （推測） |

**確認事項**:
- [ ] これらの定数の根拠は？
- [ ] 調整の経緯は？

**制作者による補完**:
- （例: 「MIN_DAMAGE = 1 はテストプレイで決めた」）
- （例: 「RANDOM_MAXは最初1.5だったが、ぶれすぎるので1.2に変更」）

---

## 特殊ケースの処理

### ケース1: [特殊ケース名]

**条件**:
[どういう状況か]

**処理**:
```cpp
// コードの該当部分
if (specialCondition) {
    // 特殊処理
}
```

**説明**:
[なぜこの特殊処理が必要か]

**確認事項**:
- [ ] この特殊ケースの意図は？
- [ ] 他にエッジケースは？

**制作者による補完**:
- （例: 「防御力が極端に高い敵への対策」）

---

### ケース2: [特殊ケース名]

（同様の形式で記述）

---

## パフォーマンス

### 計算量

**時間計算量**: O(?)
**空間計算量**: O(?)

**ボトルネック**:
- [処理名]: [理由]

**確認事項**:
- [ ] パフォーマンスの問題はありましたか？
- [ ] 最適化を試みましたか？

**制作者による補完**:
- （例: 「このアルゴリズムは高速。パフォーマンス問題なし」）
- （例: 「乱数生成が遅かった。キャッシュすれば改善できたかも」）

---

### プロファイリング結果（もしあれば）

**実行頻度**: 毎フレーム / イベント時 / その他
**平均実行時間**: XX ms（推測）

**制作者による補完**:
- （例: 「戦闘中は毎フレーム呼ばれる。最適化が重要」）

---

## テストケース

### 典型的な入力と出力

| テストケース | 入力 | 期待される出力 | 理由 |
|------------|------|--------------|------|
| 通常攻撃 | attack=50, defense=20 | 24〜36 | baseDamage=30, ±20% |
| 高防御 | attack=50, defense=60 | 0.8〜1.2 | MIN_DAMAGE適用 |
| 低防御 | attack=100, defense=5 | 76〜114 | baseDamage=95, ±20% |

**確認事項**:
- [ ] これらのケースは正しいですか？
- [ ] 他に重要なテストケースは？

**制作者による補完**:
- （例: 「クリティカルヒットのケースを追加すべき」）

---

### バグが発生したケース

**ケース1: [バグ名]**

**入力**: [入力値]
**期待**: [期待される動作]
**実際**: [実際の動作]

**原因**: [バグの原因]

**制作者による補完**:
- （例: 「defense=0のとき、除算でクラッシュした（修正済み）」）

---

## 依存関係

### 使用している関数・ライブラリ

- `randomFloat()`: 乱数生成
- `clamp()`: 値の範囲制限
- その他

**確認事項**:
- [ ] これらの関数の実装は？
- [ ] 外部ライブラリは使っていましたか？

**制作者による補完**:
- （例: 「random Float()は自前実装。標準ライブラリは使っていない」）

---

### このアルゴリズムに依存するもの

- [System1]: [理由]
- [System2]: [理由]

---

## 設計判断

### なぜこのアルゴリズムを選んだか

**制作者による説明**:
- （例: 「シンプルでわかりやすい式にしたかった」）
- （例: 「他のRPGを参考にした」）

### 他に検討した方法

**代替案1**:
- 内容: [説明]
- 採用しなかった理由: [理由]

**代替案2**:
- 内容: [説明]
- 採用しなかった理由: [理由]

**制作者による補完**:
- （例: 「乗算ベースの式も考えたが、バランス調整が難しそうで却下」）

---

## 既知の問題

### 問題1: [問題名]

**症状**: [どういう問題か]
**原因**: [なぜ発生するか]
**影響**: [ゲームプレイへの影響]

**制作者による補完**:
- （例: 「防御力が極端に高いと、戦闘が長引きすぎる」）

**対策**: [修正方法 / 未修正]

---

### 問題2: [問題名]

（同様の形式で記述）

---

## バランス調整の履歴

**制作者による記録**:

- **初期バージョン**: baseDamage = attack - defense（シンプル）
  - 問題: 防御が高すぎると攻撃が無意味

- **v2**: MIN_DAMAGE = 1 を追加
  - 改善: 最低限のダメージは与えられるように

- **v3**: 乱数要素を追加（±20%）
  - 改善: 戦闘に幅が出た

- **v4**: クリティカルヒットを検討したが未実装
  - 理由: 時間不足

---

## 改善案

### 制作者の反省点

- （例: 「もっと複雑な式にしたかった。属性相性なども」）
- （例: 「クリティカルヒットを実装すべきだった」）
- （例: 「テストケースをもっと書くべきだった」）

### 新規実装での改善方針

- （例: 「属性相性を追加」）
- （例: 「クリティカルヒット実装」）
- （例: 「ダメージ計算式を設定ファイルで変更可能に」）
- （例: 「ユニットテストを完備」）

---

## 参考資料

**参考にしたもの**:
- （例: ドラゴンクエストのダメージ計算を参考）
- （例: 攻略サイトの情報を参考）

**参考URL**（あれば）:
- [URL1]
- [URL2]

---

## メモ

**解析中の気づき**:
- （例: コメントがなく、意図の推測が難しい）
- （例: マジックナンバーが多い）

**制作者のメモ**:
- （例: 当時は式をいろいろ試した。この式に落ち着くまで2週間かかった）
- （例: バランス調整は最後まで悩んだ）

---

## 参照

- [Overview](../overview.md)
- [サブシステム](./subsystem.md)
- [関連アルゴリズム](./related-algorithm.md)
