# フレームワーク開発ガイド

このドキュメントは、仕様書駆動開発フレームワーク自体の改修・拡張を行う開発者向けのガイドです。

---
**対象読者**: フレームワークの改善・拡張を行う開発者
**所要時間**: 20分
**前提知識**: [framework-spec.md](../reference/framework-spec.md) の内容を理解していることを推奨
**次に読むべき**: [philosophy.md](./philosophy.md)（開発背景）、[contributing.md](./contributing.md)（実践手順）

---

> **📌 対象読者**: フレームワークの改善・拡張を行う開発者
>
> フレームワークを使ってゲームを開発する場合は、[クイックスタート](../tutorials/quickstart.md) を参照してください。

---

## 目次

1. [フレームワーク開発の基本方針](#1-フレームワーク開発の基本方針)
2. [開発ワークフロー](#2-開発ワークフロー)
3. [コミット規約](#3-コミット規約)
4. [推敲のチェックリスト](#4-推敲のチェックリスト)
5. [テストと検証](#5-テストと検証)
6. [リリースプロセス](#6-リリースプロセス)

---

## 1. フレームワーク開発の基本方針

### 1.1 やること

✅ **フレームワーク設計の改善**
- エージェント定義の精緻化
- 仕様書テンプレートの改善
- ワークフローの検証
- ドキュメントの整備
- 矛盾・曖昧さの解消

✅ **変更の記録**
- Git で変更を追跡
- CHANGELOG.md に変更内容を記録
- コミットメッセージで意図を明確に

### 1.2 やらないこと

❌ **実装**
- ゲームのコード実装
- 実プロジェクトへの展開
- 動作検証用のコード作成

❌ **範囲外の拡張**
- 新しいゲームジャンルへの対応
- 3D対応
- 新エンジン対応

詳細は [contributing.md](./contributing.md) を参照してください。

---

## 2. 開発ワークフロー

### 2.1 基本フロー

Claude Code は worktree を自動生成するため、以下の手順で作業します。

```bash
# 1. 原本リポジトリで Claude Code を起動
cd ~/repo/spec-driven-framework
claude

# 2. 開発作業を行う（worktree が自動生成される）
> spec-agent の定義をレビューして...

# 3. 作業完了したらコミット
> 変更をコミットして

# 4. 原本にマージ（セッション内で実行）
> 原本にマージして
# または手動で:
# cd ~/repo/spec-driven-framework && git merge <worktree-branch>

# 5. セッション終了
exit
```

### 2.2 なぜ毎回マージするのか

- Claude Code は作業ごとに新しい worktree（ブランチ）を生成する
- マージしないと、次回のセッションで別ブランチが作られ変更が分散する
- **原本の `master` を常に最新に保つ**ことで、継続的な開発が可能

### 2.3 コンテキストの鮮度を保つ

- 長時間の `/clear` 継続より、**新規セッション**を推奨
- セッションが変わっても Git に履歴が残るので問題なし
- コンテキスト蓄積による精度劣化を防ぐ

---

## 3. コミット規約

### 3.1 コミットの粒度

**各修正ごとに個別にコミットしてください。**

- 1つの問題修正 = 1つのコミット
- 複数の問題をまとめてコミットしない
- 変更の追跡とレビューを容易にするため

```bash
# 良い例
git commit -m "fix: critic-agent の依存関係チェック項目を削除"
git commit -m "fix: architecture-agent と deps-agent の協調方法を明文化"

# 悪い例（複数の修正をまとめている）
git commit -m "fix: エージェント定義の複数の問題を修正"
```

### 3.2 コミットメッセージ形式

```
[対象] type: 変更の概要

- 詳細な変更内容1
- 詳細な変更内容2

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
```

**対象の例**:
- `[agents]` - エージェント定義
- `[commands]` - コマンド定義
- `[skills]` - スキル定義
- `[docs]` - ドキュメント
- `[framework]` - フレームワーク全体

**type の例**:
- `feat:` - 新機能追加
- `fix:` - バグ修正
- `refactor:` - リファクタリング
- `docs:` - ドキュメント更新
- `chore:` - その他の変更

---

## 4. 推敲のチェックリスト

### 4.1 エージェント設計

- [ ] 各エージェントの責務境界は明確か
- [ ] エージェント間の連携フローは適切か
- [ ] 入出力の定義は十分か
- [ ] 「できること」「できないこと」が明記されているか
- [ ] 禁止事項とエスカレーション条件が定義されているか

### 4.2 仕様書体系

- [ ] 番号体系は一貫しているか
- [ ] テンプレートは使いやすいか
- [ ] ID管理ルールは明確か
- [ ] 層間の依存関係ルールは適切か

### 4.3 ワークフロー

- [ ] 開発フローは網羅的か
- [ ] エッジケースの対応は考慮されているか
- [ ] エラー時のフォールバックは定義されているか
- [ ] 並列セッション実行の考慮がされているか

### 4.4 ドキュメント

- [ ] ユーザーズガイドは分かりやすいか
- [ ] 用語の定義は一貫しているか
- [ ] 導入手順は明確か
- [ ] index.md は全ドキュメントを網羅しているか
- [ ] 各ドキュメントの概要は適切か

### 4.5 コマンドとスキル

- [ ] コマンドの使用タイミングは明確か
- [ ] 人間専用/エージェント専用の区別は適切か
- [ ] スキルの参照関係は正しいか

---

## 5. テストと検証

### 5.1 Git hooks のインストール（推奨）

**AIの暴走を防ぐ pre-commit hook を提供しています。**

```bash
# インストール
cp .git-hooks/pre-commit .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

**チェック内容**:
- ✅ 禁止依存の検出（Player ↔ Enemy 等）
- ✅ @spec コメントの存在確認
- ✅ EARS記法の曖昧な表現検出
- ✅ ID重複チェック

コミット前に自動的に検証され、問題があればコミットがブロックされます。

**バイパス方法**（非推奨）:
```bash
git commit --no-verify
```

### 5.2 整合性チェック

定期的に以下のチェックを実行してください：

```bash
# ID重複チェック
python3 scripts/validate-ids.py

# リンク切れチェック
python3 scripts/validate-links.py

# 依存関係チェック
python3 scripts/validate-deps.py
```

---

## 6. リリースプロセス

### 6.1 バージョン管理

このフレームワークは [Semantic Versioning](https://semver.org/lang/ja/) に従います。

- **MAJOR**: 互換性のない変更
- **MINOR**: 後方互換性のある機能追加
- **PATCH**: 後方互換性のあるバグ修正

### 6.2 リリースフロー

```bash
# 1. CHANGELOG.md を更新
# Unreleased セクションの内容を新バージョンに移動

# 2. バージョンタグを作成
git tag -a v2.17.0 -m "Release v2.17.0"

# 3. リモートにプッシュ（必要に応じて）
git push origin v2.17.0
```

### 6.3 リリースノート

各リリースには以下の情報を含めます：

- **Added**: 新機能
- **Changed**: 既存機能の変更
- **Deprecated**: 廃止予定の機能
- **Removed**: 削除された機能
- **Fixed**: バグ修正
- **Security**: セキュリティ関連の変更

詳細は [CHANGELOG.md](../CHANGELOG.md) を参照してください。

---

## 7. トラブルシューティング

### 7.1 worktree の問題

**問題**: worktree が残ってしまう

```bash
# worktree 一覧を確認
git worktree list

# 不要な worktree を削除
git worktree remove <path>

# または強制削除
git worktree remove --force <path>
```

### 7.2 マージの競合

**問題**: マージ時に競合が発生

```bash
# 競合箇所を確認
git status

# 競合を解決後
git add <resolved-files>
git commit
```

### 7.3 コミットのやり直し

**問題**: コミットメッセージを修正したい

```bash
# 直前のコミットメッセージを修正
git commit --amend

# 注意: push 済みの場合は force push が必要（非推奨）
```

---

## 8. 関連ドキュメント

- [contributing.md](./contributing.md) - 推敲の進め方（基本方針）
- [philosophy.md](./philosophy.md) - なぜこのシステムを作っているのか
- [CHANGELOG.md](../CHANGELOG.md) - 変更履歴
- [spec.md](../spec.md) - フレームワーク仕様書

---

## 9. サポート

### 内部開発

- タスク管理: Markdown ファイルベースのタスクシステムを使用

### 外部からの質問・提案

外部からの質問や提案の受付方法は準備中です。

---

## 10. ライセンス

（検討中）
