# エージェントガイド

Claude Code サブエージェントの選択と詳細仕様。

---
**対象読者**: エージェントの使い方を知りたい開発者
**所要時間**: 30分（全体）、必要箇所のみ参照可能
**前提知識**: なし（初心者でも利用可能）

---

## 目次

- [クイックリファレンス](#クイックリファレンス)
- [エージェント選択フローチャート](#エージェント選択フローチャート)
- [典型的なワークフロー](#典型的なワークフロー)
- [全エージェント詳細](#全エージェント詳細)

---

## クイックリファレンス

| 状況 | 使うエージェント |
|------|----------------|
| アイデアが曖昧 | 💬 requirements-agent |
| 要件は明確、仕様書を書く | 📋 spec-agent |
| 仕様書の内容を批評 | 🔍 critic-agent |
| データ構造を設計 | 🏗️ design-agent |
| ロジックを設計 | ⚙️ behavior-agent |
| テスト設計を相談 | 🧪 test-agent |
| コードを実装 | 💻 impl-agent |
| 整合性をチェック | ✅ review-agent |
| 依存関係を確認 | 🔗 deps-agent |
| プランからタスクを作成 | 📝 task-registration.md |
| タスクを開始/完了 | 🗂️ task-manager-agent |
| 定期監査を実行 | 🔍 audit-agent |

---

## エージェント選択フローチャート

### Q1: 何をしたいですか？

```
┌─────────────────────────────────────────┐
│ 何をしたいですか？                        │
└─────────────────────────────────────────┘
           │
           ├─ 0. プランからタスクを作成 → 📝 task-registration.md
           ├─ 0.1 タスクを開始/完了 → 🗂️ task-manager-agent
           ├─ A. 新しい機能を考えている → Q2へ
           ├─ B. 既存の仕様を修正したい → Q3へ
           ├─ C. 実装したい → Q4へ
           ├─ D. 検証したい → Q5へ
           └─ E. アーキテクチャ設計 → Q6へ
```

### Q2: 要件は明確ですか？（新機能）

```
┌─────────────────────────────────────────┐
│ 要件は明確ですか？                        │
└─────────────────────────────────────────┘
           │
           ├─ はい、明確です
           │   → 📋 spec-agent
           │      EARS記法で文書化
           │
           └─ いいえ、まだ曖昧です
               → 💬 requirements-agent
                  対話で深掘り
                  ↓
                  要件が固まったら
                  → 📋 spec-agent
```

### Q3: 何を修正しますか？（既存仕様）

```
┌─────────────────────────────────────────┐
│ 何を修正しますか？                        │
└─────────────────────────────────────────┘
           │
           ├─ 仕様の内容（REQ）
           │   1. 💬 requirements-agent で修正内容を深掘り
           │   2. 📋 spec-agent で spec.md を更新
           │   3. 🔍 critic-agent で影響範囲を確認
           │
           ├─ データ構造（Component, Enum）
           │   → 🏗️ design-agent
           │
           ├─ ロジック（System, 状態遷移）
           │   → ⚙️ behavior-agent
           │
           └─ 実装（テストコード + プロダクトコード）
               → 💻 impl-agent（🧪 test-agent に相談可）
```

### Q4: 何を実装しますか？

```
┌─────────────────────────────────────────┐
│ 何を実装しますか？                        │
└─────────────────────────────────────────┘
           │
           ├─ 新しい機能の実装
           │   └─ 仕様書はありますか？
           │       ├─ はい → 💻 impl-agent
           │       └─ いいえ → まず 📋 spec-agent
           │
           └─ 既存機能の修正
               └─ 仕様書を先に更新しましたか？
                   ├─ はい → 💻 impl-agent
                   └─ いいえ → まず 📋 spec-agent
```

### Q5: 何を検証しますか？

```
┌─────────────────────────────────────────┐
│ 何を検証しますか？                        │
└─────────────────────────────────────────┘
           │
           ├─ 仕様書の内容（矛盾、漏れ）
           │   → 🔍 critic-agent
           │
           ├─ 仕様書の整合性（ID重複、リンク切れ）
           │   → ✅ review-agent
           │
           ├─ 依存関係
           │   → 🔗 deps-agent
           │
           ├─ データの整合性
           │   → 📊 data-agent
           │
           └─ プロジェクト全体の定期監査
               → 🔍 audit-agent
```

### Q6: アーキテクチャ設計

```
┌─────────────────────────────────────────┐
│ アーキテクチャ設計                        │
└─────────────────────────────────────────┘
           │
           ├─ イベントシステム設計
           │   → 🏛️ architecture-agent
           │
           ├─ 共有Component定義
           │   → 🏛️ architecture-agent
           │
           ├─ 依存関係設計
           │   → 🔗 deps-agent
           │
           └─ 拡張性が必要な機能
               → 🧩 module-design-agent
```

---

## 典型的なワークフロー

### パターンA: 新機能を最初から作る（完全版）

```
1. 💬 requirements-agent
   「ジャンプ機能について相談したい」
   → 対話で要件を深掘り

2. 📋 spec-agent
   「要件をspec.mdに文書化して」
   → 30101_player_spec.md を作成

3. 🔍 critic-agent
   「この仕様を批評して」
   → 矛盾・漏れを指摘

4. 🏗️ design-agent
   「Playerのデータ構造を設計して」
   → 30102_player_design.md を作成

5. ⚙️ behavior-agent
   「Playerのロジックを設計して」
   → 30103_player_behavior.md を作成

6. 🗂️ task-manager-agent
   「Player機能のタスクを作成して」
   → Markdownタスクファイル作成

7. 💻 impl-agent
   「Playerを実装して」
   → テストコード + プロダクトコード実装（🧪 test-agent に相談可）

8. ✅ review-agent
   「整合性をチェックして」
   → ID重複、リンク切れを検証
```

### パターンB: 要件が明確な場合（短縮版）

```
1. 📋 spec-agent
   「Enemyの巡回AIをspec.mdに書いて」

2. 🔍 critic-agent（念のため）
   「この仕様を批評して」

3. 🏗️ design-agent + ⚙️ behavior-agent
   「詳細設計を作成して」

4. 💻 impl-agent
   「実装して」（🧪 test-agent に相談可）

5. ✅ review-agent
   「検証して」
```

### パターンC: バグ修正

```
1. 🗂️ task-manager-agent
   「Playerバグ修正のタスクを作成して」
   → タスク作成（必須）

2. ✅ review-agent
   「Player仕様の問題を特定して」
   → 原因を特定

3. 📋 spec-agent
   「spec.mdを修正して」
   → 仕様書を先に修正

4. 💻 impl-agent
   「実装を修正して」

5. ✅ review-agent
   「再検証して」
```

---

## 全エージェント詳細

### 💬 requirements-agent（要件の深掘り）

**いつ使う:** 新機能のアイデアを深掘りするとき、エッジケースを詰めたいとき

**やること:**
1. 対話を通じて要件を深掘り
2. 視点漏れをチェック（プレイヤー/テスター/開発者視点）
3. 矛盾を検出して指摘
4. エッジケースを洗い出し
5. 要件サマリを作成

**入力:** アイデア、要望
**出力:** 要件サマリ（対話結果のまとめ）

**重要**: このエージェントは文書化（spec.md の作成）を行いません。

**呼び出し例:**
```
「ジャンプ機能について相談したい」
「この機能のエッジケースを詰めたい」
「要件を固めてから仕様書にしたい」
```

---

### 🔍 critic-agent（仕様の批評・検証）

**いつ使う:** 仕様書の問題点を洗い出したいとき

**やること:**
1. 完全性チェック（すべてのケースがカバーされているか）
2. 一貫性チェック（矛盾がないか）
3. 明確性チェック（曖昧な表現がないか）
4. 実現可能性チェック（実装可能か）
5. テスト可能性チェック（検証可能か）

**入力:** spec.md, design.md, behavior.md
**出力:** 批評レポート

**重要**: このエージェントは修正を行いません。問題の指摘と改善提案のみ。

**呼び出し例:**
```
「この仕様を批評して」
「矛盾や漏れがないかチェックして」
「spec.md の問題点を指摘して」
```

---

### 📋 spec-agent（要件定義）

**いつ使う:** 新機能の要件を決めるとき

**やること:**
1. EARS 記法で要件を定義
2. 制約条件（事前/事後/不変条件）を定義
3. REQ-ID を採番
4. テストとの紐付けを準備

**入力:** アイデア、concept.md
**出力:** xxxxx_spec.md

**呼び出し例:**
```
「Player のジャンプ機能の要件を定義して」
「Enemy の AI パターンの仕様を書いて」
「REQ を追加して」
```

---

### 🏗️ design-agent（データ構造設計）

**いつ使う:** spec.md 完成後、データ構造を設計するとき

**やること:**
1. Component のフィールドを定義
2. 定数を定義
3. Enum を定義
4. 共有 Component を参照リンクで記載

**入力:** spec.md
**出力:** xxxxx_design.md

**重要なルール:**
- **データのみ**: フィールド、定数、Enum
- **ロジック禁止**: メソッド、処理の説明は書かない
- **動詞禁止**: 「〜する」「〜した場合」は behavior.md へ

**呼び出し例:**
```
「Player の Component を設計して」
「Enemy のデータ構造を定義して」
「design.md を作成して」
```

---

### ⚙️ behavior-agent（ロジック設計）

**いつ使う:** design.md 完成後、ロジックを設計するとき

**やること:**
1. System の責務を定義
2. 状態遷移図を作成
3. アルゴリズムを説明
4. エッジケースを言語化

**入力:** spec.md, design.md
**出力:** xxxxx_behavior.md

**記述の重点（コードではなくルール）:**
- **タイミング**: 即時？フレーム末？遅延あり？
- **境界値**: 0以下？未満？最小値保証？
- **例外**: 入力バッファ、キャンセル可否
- **優先順位**: 複数条件の同時成立時

**呼び出し例:**
```
「Player の移動ロジックを設計して」
「状態遷移を定義して」
「behavior.md を作成して」
```

---

### 🧪 test-agent（テスト設計支援）

**いつ使う:** impl-agent がテストコードを書く際に相談したいとき

**やること:**
1. テストファイル構造の設計支援
2. テストケースの設計支援（どのテストを書くべきか）
3. REQ-ID とテスト名の対応設計
4. カバレッジ漏れの検出
5. 境界値・エッジケースのテスト設計

**入力:** spec.md, behavior.md, design.md
**出力:** テスト設計レポート

**重要:** このフレームワークでは test.md を作成しません。

**呼び出し例:**
```
「テストケースの設計を相談したい」
「カバレッジ漏れがないか確認して」
「境界値テストはどう設計すべき？」
```

---

### 💻 impl-agent（実装）

**いつ使う:** 仕様書が揃った後、コードを書くとき

**やること:**
1. 仕様書を全て読む（spec, design, behavior）
2. design.md → Component コード
3. behavior.md → System コード
4. spec.md の REQ-ID に基づきテストコードを作成
   - 必要に応じて test-agent にテスト設計を相談
5. @spec/@test/@data コメントを付与

**入力:** 全仕様書（spec, design, behavior）
**出力:** コード（テストコード + プロダクトコード）

**厳守ルール:**
- 仕様書にない機能は実装しない
- 仕様書と異なる実装をしない
- 対応コメントを必ず付与

**呼び出し例:**
```
「Player を実装して」
「仕様書に従ってコードを書いて」
「30101 の実装をして」
```

---

### 🏛️ architecture-agent（アーキテクチャ設計）

**いつ使う:**
- 新規プロジェクト開始時（Phase 0.5）: プロジェクト初期化の直後
- 随時: イベントシステム、入力システム、共有Componentの設計が必要になったとき

**やること:**
1. イベントシステムの設計
2. 入力システムの設計
3. レイヤー構成の設計
4. 共有Componentの設計
5. 依存関係ルールの定義

**入力:** concept.md, ゲームの基本要件
**出力:** 2_architecture/*.md

**呼び出し例:**
```
「イベントシステムを設計して」
「入力システムを定義して」
「共有Componentを設計して」
```

---

### ✅ review-agent（整合性検証）

**いつ使う:** 定期的に、または問題が疑われるとき

**やること:**
1. ID 重複チェック
2. 参照整合性チェック
3. 未テスト要件の検出
4. 禁止依存の検出
5. リンク切れチェック

**入力:** 全仕様書
**出力:** レポート

**呼び出し例:**
```
「仕様書の整合性をチェックして」
「/docs-validate を実行して」
「問題がないか確認して」
```

---

### 🔗 deps-agent（依存関係管理）

**いつ使う:** 新機能追加時、依存関係の確認時

**やること:**
1. Mermaid 依存図の更新
2. 禁止依存パターンの検出
3. リンク切れ検出
4. 20002_dependencies.md の維持

**呼び出し例:**
```
「依存関係を更新して」
「禁止依存がないかチェックして」
「/deps-check を実行して」
```

---

### ♻️ refactor-agent（リファクタリング・廃止）

**いつ使う:** 機能廃止時、Component 共有化時

**やること:**
1. 参照元の特定
2. 安全な移行の実行
3. _deprecated/ への移動
4. 依存関係の更新

**呼び出し例:**
```
「古い機能を廃止して」
「HealthComponent を共有化して」
「/component-share を実行して」
```

---

### 📊 data-agent（データテーブル管理）

**いつ使う:** マスタデータの作成・更新時

**やること:**
1. テーブル作成（Markdown 形式）
2. テーブル間参照の整合性確認
3. balance 調整

**呼び出し例:**
```
「敵のパラメータテーブルを作成して」
「balance 調整して」
「8_data を更新して」
```

---

### 📝 task-registration.md（タスク登録）

**いつ使う:** プランファイルからタスクを作成するとき

**やること:**
1. プランファイルの自動検出
2. タスクタイプ判定（framework/game-dev/project-wide）
3. ID採番（/id-next）
4. タスクファイル生成（status: todo）

**入力:** ~/.claude/plans/*.md
**出力:** tasks/1_todo/*.md または project/tasks/1_todo/*.md

**呼び出し例:**
```
「プランからタスクを作成して」
「タスクを登録して」
```

---

### 🗂️ task-manager-agent（タスク管理）

**いつ使う:** タスクの開始/完了、worktree管理

**やること:**
1. タスク開始（status: todo → in-progress）
2. worktree作成（game-devタスクのみ）
3. タスク完了（status: in-review → done）
4. 依存関係管理

**呼び出し例:**
```
「タスク30101を開始して」
「タスク30101を完了にして」
「タスク状況を確認して」
```

---

### 🔍 audit-agent（定期コード監査）

**いつ使う:** プロジェクト全体のコード健康診断を行いたいとき

**やること:**
1. 仕様整合性チェック（/impl-validate の活用）
2. 依存関係チェック（/deps-check の活用）
3. コード品質分析（複雑度、重複、Dead Code）
4. アーキテクチャ分析（レイヤー違反、責務過多）
5. 診断レポート生成
6. リファクタタスク（R30XXX-NNN）の提案

**入力:** プロジェクト全体（または指定範囲）
**出力:** 診断レポート、推奨タスク一覧

**重要**: review-agent との違い
- **audit-agent**: 定期実行（プロアクティブ）、プロジェクト全体、広く浅く
- **review-agent**: タスク完了後（リアクティブ）、個別タスク、狭く深く

**呼び出し例:**
```
「コードを監査して」
「プロジェクト全体の健康診断をして」
「変更ファイルだけ監査して」
```

---

## エージェント選択の判断基準

### 1. 「対話が必要か？」

- **必要** → 💬 requirements-agent
- **不要** → 📋 spec-agent

### 2. 「仕様書があるか？」

- **ある** → 💻 impl-agent
- **ない** → 📋 spec-agent

### 3. 「何をチェックするか？」

- **内容**（矛盾、曖昧さ） → 🔍 critic-agent
- **形式**（ID、リンク） → ✅ review-agent

### 4. 「設計レイヤーはどこか？」

- **データ** → 🏗️ design-agent
- **ロジック** → ⚙️ behavior-agent
- **テスト設計** → 🧪 test-agent に相談

### 5. 「横断的関心事か？」

- **依存関係** → 🔗 deps-agent
- **共有Component** → ♻️ refactor-agent
- **マスタデータ** → 📊 data-agent
- **アーキテクチャ** → 🏛️ architecture-agent

---

## 補足: 類似エージェントの使い分け

### session-manager-agent vs task-manager-agent（worktree管理）

| 状況 | 使用エージェント | 説明 |
|------|----------------|------|
| **複数タスクを並列実行したい** | 🎯 session-manager-agent | 複数worktreeを一括作成 |
| **単一タスクを開始したい** | 🗂️ task-manager-agent | 1つのworktreeを作成 |
| **セッション間の競合を調整** | 🎯 session-manager-agent | マージ順序を提案 |
| **タスク状態を変更（開始/完了）** | 🗂️ task-manager-agent | ライフサイクル管理 |

**役割分担**:
- session-manager: 並列セッションの**コーディネーター**
- task-manager: 個別タスクの**ライフサイクル管理**

### critic-agent vs review-agent

| チェック内容 | 使用エージェント | 判断基準 |
|------------|----------------|---------|
| 曖昧な表現、状態遷移の漏れ | 🔍 critic-agent | 人間的判断が必要 |
| ID重複、参照切れ、リンク切れ | ✅ review-agent | 機械的にチェック可能 |
| 実現可能性の評価 | 🔍 critic-agent | 設計知識が必要 |
| 未テスト要件の検出 | ✅ review-agent | 自動検出可能 |

---

## 関連ドキュメント

- [フレームワーク仕様書](../reference/framework-spec.md) - 完全な仕様
- [ツールリファレンス](../reference/tools-reference.md) - コマンド一覧
