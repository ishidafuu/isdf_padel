# フレームワーク概要

仕様書駆動開発フレームワークの設計思想と基本概念

---
**対象読者**: フレームワークを深く理解したい開発者
**所要時間**: 20分
**前提知識**: なし

---

## 目次

- [このフレームワークが解決する問題](#このフレームワークが解決する問題)
- [基本原則](#基本原則)
- [基本概念と用語](#基本概念と用語)
- [プロジェクト構成](#プロジェクト構成)
- [開発フロー概要](#開発フロー概要)

---

## このフレームワークが解決する問題

ゲーム開発でよくある問題:

| 問題 | 従来の状況 | このフレームワークの解決策 |
|------|-----------|--------------------------|
| 仕様が曖昧 | 「いい感じに」「適切に」 | EARS記法で厳密に定義 |
| 仕様と実装の乖離 | コードと設計書がバラバラ | 仕様書を Single Source of Truth に |
| AI への指示が難しい | 毎回ゼロから説明 | エージェントが文脈を理解 |
| 変更の影響範囲が不明 | 修正したら別の場所が壊れる | 依存関係を明示的に管理 |

---

## 基本原則

### 仕様書 = Single Source of Truth

```
┌─────────────────────────────────────────────────────┐
│           仕様書 = Single Source of Truth            │
│                                                     │
│  仕様書にないものは実装しない                         │
│  実装を変えるなら、まず仕様書を変える                  │
│  AIエージェントは仕様書に従って動く                   │
└─────────────────────────────────────────────────────┘
```

### ECS アーキテクチャとの関係

このフレームワークは ECS（Entity-Component-System）を前提としています:

| ECS概念 | 仕様書での対応 | 説明 |
|--------|---------------|------|
| Entity | spec + design の組み合わせ | 「何であるか」の定義 |
| Component | design.md | データ構造（フィールドのみ） |
| System | behavior.md | ロジック（処理のみ） |

**重要な分離原則:**
- **design.md**: データだけ（「何を持っているか」）
- **behavior.md**: ロジックだけ（「どう動くか」）

---

## 基本概念と用語

### 仕様書の種類

| ファイル | 役割 | 含む内容 | 含まない内容 |
|---------|------|---------|-------------|
| **spec.md** | 要件定義 | 何を満たすべきか（EARS記法） | 実装方法 |
| **design.md** | データ構造 | Component, 定数, Enum | メソッド, ロジック |
| **behavior.md** | ロジック | System, 状態遷移, アルゴリズム | データ定義 |
| **test.md** | テスト | Given/When/Then シナリオ | 実装コード |

### ID 体系

トレーサビリティのため、すべての要素に一意の ID を付与:

```
[種別]-[ファイル番号]-[連番3桁]

例: REQ-30101-001
    │    │     │
    │    │     └── 連番（001, 002, ...）
    │    └──────── ファイル番号（30101_player_spec.md）
    └───────────── 種別（REQ = 要件）
```

| 種別 | 意味 | 使用場所 |
|------|------|---------|
| REQ | Requirement（要件） | spec.md |
| DES | Design（設計要素） | design.md |
| BHV | Behavior（振る舞い） | behavior.md |
| TST | Test（テストケース） | test.md |

### EARS 記法

要件を曖昧さなく記述するための構造化記法:

```markdown
### REQ-30101-001: 地上ジャンプ
- WHEN プレイヤーがジャンプボタンを押す
- AND プレイヤーが地上にいる
- THE SYSTEM SHALL プレイヤーを上方向に加速させる
- WITH 初速度 10m/s
- **テスト**: TST-30105-001
```

**5つのパターン:**

| パターン | 構文 | いつ使う |
|---------|------|---------|
| **Ubiquitous** | THE SYSTEM SHALL [動作] | 常に成り立つ |
| **Event-driven** | WHEN [イベント], THE SYSTEM SHALL [動作] | イベント起因 |
| **State-driven** | WHILE [状態], THE SYSTEM SHALL [動作] | 状態依存 |
| **Optional** | WHERE [条件], THE SYSTEM SHALL [動作] | 条件付き |
| **Unwanted** | IF [異常], THEN THE SYSTEM SHALL [対応] | 異常系 |

---

## プロジェクト構成

### ディレクトリ構造

```
project-root/
│
├── CLAUDE.md                    # Claude Code への指示書
├── .claudeignore                # 除外設定
│
├── .claude/
│   ├── agents/                  # サブエージェント定義
│   ├── commands/                # スラッシュコマンド
│   └── skills/                  # スキルファイル
│
├── docs/                        # フレームワークドキュメント
│
├── tasks/                       # フレームワーク開発タスク（FXXX）
│
└── project/                     # ゲーム開発エリア
    ├── docs/                    # ゲーム仕様書群
    │   ├── 1_project/           # プロジェクト定義
    │   ├── 2_architecture/      # アーキテクチャ定義
    │   ├── 3_ingame/            # インゲーム機能
    │   ├── 4_outgame/           # アウトゲーム機能
    │   └── 8_data/              # マスタデータ
    ├── src/                     # ゲームコード
    ├── tests/                   # テストコード
    └── tasks/                   # ゲーム開発タスク（30XXX/PXXX）
```

### 各層の役割

```
┌─────────────────────────────────────────────────────┐
│  1_project/     プロジェクトの「何を作るか」          │
│  ─────────────────────────────────────────────────  │
│  concept.md, gdd.md, tech_stack.md                  │
└─────────────────────────────────────────────────────┘
                         ↑ 参照
┌─────────────────────────────────────────────────────┐
│  2_architecture/  プロジェクトの「どう作るか」        │
│  ─────────────────────────────────────────────────  │
│  layers.md, dependencies.md, event_system.md        │
│  209_components/ (共有Component)                    │
└─────────────────────────────────────────────────────┘
                         ↑ 参照
┌─────────────────────────────────────────────────────┐
│  3_ingame/        ゲーム中の機能仕様                 │
│  4_outgame/       ゲーム外の機能仕様                 │
│  ─────────────────────────────────────────────────  │
│  301_player/, 302_enemy/, 401_title/ など           │
└─────────────────────────────────────────────────────┘
        ↑
        │ 横断参照（データのみ）
┌─────────────────────────────────────────────────────┐
│  8_data/          マスタデータ（参照される専用）      │
│  ─────────────────────────────────────────────────  │
│  801_tables/enemy_params.md など                    │
│  ※ 8_data から他層への参照は禁止                    │
└─────────────────────────────────────────────────────┘
```

### ミニマムスタート

最初からすべてを揃える必要はありません:

**初期構成（これだけでOK）:**
```
project/docs/
├── 1_project/
│   └── 10001_concept.md
└── 3_ingame/
    └── 301_player/
        ├── 30101_player_spec.md
        └── 30102_player_design.md
```

**拡張タイミング:**
| いつ | 何を追加 |
|------|---------|
| 2つ目の機能を作るとき | 20002_dependencies.md |
| 共有 Component が必要になったとき | 209_components/ |
| データテーブルが必要になったとき | 8_data/ |

---

## 開発フロー概要

### プロジェクト初期化フロー（Phase 0 → 0.5）

```
┌─────────────────────────────────────────────────────────────┐
│ Phase 0: プロジェクト初期化                                   │
├─────────────────────────────────────────────────────────────┤
│  🔧 setup-agent                                             │
│  「新規プロジェクトを初期化して」                             │
│  → docs/ フォルダ構成、CLAUDE.md、concept.md を作成          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ Phase 0.5: アーキテクチャ設計（推奨）                          │
├─────────────────────────────────────────────────────────────┤
│  🏛️ architecture-agent                                      │
│  「アーキテクチャの基盤を作って」                             │
│  → layers.md, event_system.md, input_system.md を作成       │
└─────────────────────────────────────────────────────────────┘
                              ↓
                    Phase 1: 機能仕様策定へ
```

### 新機能開発フロー

```
Step 1: 仕様策定
  spec-agent → design-agent → behavior-agent → test-agent
  → 各仕様書を作成

Step 2: タスク作成
  task-manager-agent
  → タスクファイル作成、worktree作成

Step 3: 仕様コミット
  git commit -m "[30101] spec: ジャンプ機能の要件追加"

Step 4: 実装
  impl-agent
  → @spec コメント付きのコードを生成

Step 5: 検証
  review-agent
  → ID重複、参照整合性をチェック
  → PR作成 → レビュー → マージ
```

### 仕様変更フロー

```
変更依頼
    │
    ▼
┌─────────────────────────────────────────┐
│ 0. タスク作成（必須：最初のステップ）    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 影響範囲の確認                        │
│    deps-agent で依存関係を確認           │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 仕様書の更新（上流から順に）          │
│    spec-agent → design-agent →          │
│    behavior-agent → test-agent          │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 整合性確認                           │
│    review-agent でチェック               │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. 実装修正                             │
│    impl-agent で修正                     │
└─────────────────────────────────────────┘
```

### タスク優先原則

すべての変更作業は、必ずタスク作成から開始します:
- 新機能開発
- バグ修正
- 仕様変更
- リファクタリング

---

## クイックリファレンス

### ファイル番号計算

```
フォルダ番号 = 親番号 × 100 + サブ番号
ファイル番号 = フォルダ番号 × 100 + 種別番号

例: 301_player/spec.md
    → フォルダ番号 = 3 × 100 + 01 = 301
    → ファイル番号 = 301 × 100 + 01 = 30101
```

### コミットメッセージ

```
[番号] spec:     要件変更
[番号] design:   データ構造変更
[番号] behavior: ロジック変更
[番号] test:     テスト変更
[番号] feat:     新機能実装
[番号] fix:      バグ修正
[番号] refactor: リファクタリング
```

### 禁止事項チェックリスト

| 禁止事項 | 理由 | 対処法 |
|---------|------|--------|
| 仕様書なしで実装 | 乖離の原因 | 先に仕様書を作成 |
| design.md にロジック | 責務違反 | behavior.md に移動 |
| Player → Enemy 直接参照 | 依存禁止 | EventSystem 経由 |
| 8_data → 他層の参照 | データ層は参照専用 | 参照方向を逆に |
| @spec コメント省略 | 対応関係が不明 | 必ず付与 |

---

## 関連ドキュメント

- [エージェントガイド](./agents.md) - エージェントの選択と詳細
- [タスク管理](./tasks.md) - タスク管理システムの使い方
- [フレームワーク仕様書](../reference/framework-spec.md) - 完全な仕様
- [仕様書の書き方](../reference/spec-writing-guide.md) - 仕様書執筆ガイド
